<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Mysql备份的种种实现方案 - Even - A super concise theme for Hugo</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="olOwOlo" /><meta name="description" content="mysql 数据备份 mysql主从复制的两种解决方案 传统方式： MSQL支持单向、异步复制。传统的方式中,由n台机器充当主服务器, n台机器充当备服务器 n" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.100.2 with theme even" />


<link rel="canonical" href="https://hzjsea.github.io/post/mysql%E5%A4%87%E4%BB%BD%E7%9A%84%E7%A7%8D%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Mysql备份的种种实现方案" />
<meta property="og:description" content="mysql 数据备份 mysql主从复制的两种解决方案 传统方式： MSQL支持单向、异步复制。传统的方式中,由n台机器充当主服务器, n台机器充当备服务器 n" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hzjsea.github.io/post/mysql%E5%A4%87%E4%BB%BD%E7%9A%84%E7%A7%8D%E7%A7%8D%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-08-01T11:40:30+08:00" />
<meta property="article:modified_time" content="2022-08-01T11:40:30+08:00" />

<meta itemprop="name" content="Mysql备份的种种实现方案">
<meta itemprop="description" content="mysql 数据备份 mysql主从复制的两种解决方案 传统方式： MSQL支持单向、异步复制。传统的方式中,由n台机器充当主服务器, n台机器充当备服务器 n"><meta itemprop="datePublished" content="2022-08-01T11:40:30+08:00" />
<meta itemprop="dateModified" content="2022-08-01T11:40:30+08:00" />
<meta itemprop="wordCount" content="9518">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Mysql备份的种种实现方案"/>
<meta name="twitter:description" content="mysql 数据备份 mysql主从复制的两种解决方案 传统方式： MSQL支持单向、异步复制。传统的方式中,由n台机器充当主服务器, n台机器充当备服务器 n"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Even</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Even</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Mysql备份的种种实现方案</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-08-01 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#mysql-数据备份">mysql 数据备份</a>
      <ul>
        <li><a href="#主从复制binlog与relaylog">主从复制binlog与relaylog</a>
          <ul>
            <li><a href="#slave_io_running与slave_sql_running-状态异常">Slave_IO_Running与Slave_SQL_Running 状态异常</a></li>
          </ul>
        </li>
        <li><a href="#基于二进制日志点的异步复制解决方案">基于二进制日志点的异步复制解决方案</a></li>
        <li><a href="#主从同步进阶版--读写分离">主从同步进阶版&ndash;读写分离</a></li>
        <li><a href="#golang-从程序角度看如何实现读写分离">Golang 从程序角度看如何实现读写分离</a></li>
        <li><a href="#master和salve数据库的数据不一致解决方案">master和salve数据库的数据不一致解决方案</a>
          <ul>
            <li><a href="#mysqldump-冷备份">mysqldump 冷备份</a></li>
            <li><a href="#xtrabackup-热备份">Xtrabackup 热备份</a></li>
          </ul>
        </li>
        <li><a href="#xtrabackup详解">xtrabackup详解</a></li>
        <li><a href="#错误">错误</a>
          <ul>
            <li><a href="#docker-mysql">docker mysql</a></li>
            <li><a href="#innobackupex-命令出错">innobackupex 命令出错</a></li>
            <li><a href="#docker-mysql无法被innobackupex备份">docker-mysql无法被innobackupex备份</a></li>
          </ul>
        </li>
        <li><a href="#docker-mysql重启数据库">docker-mysql重启数据库</a></li>
        <li><a href="#docker-mysql运行">docker-mysql运行</a></li>
        <li><a href="#mysql-fake-data">mysql fake data</a></li>
        <li><a href="#extra">extra</a></li>
        <li><a href="#基于mysql的主从复制案例未测试">基于MYSQL的主从复制案例，未测试</a></li>
        <li><a href="#脚注">脚注</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="mysql-数据备份">mysql 数据备份</h1>
<p>mysql主从复制的两种解决方案</p>
<ol>
<li>
<p>传统方式：<br>
MSQL支持单向、异步复制。传统的方式中,由n台机器充当主服务器, n台机器充当备服务器 n的数量根据架构的方案来决定, 架构的方案根据服务器的承载量来决定</p>
<p>在数据库的运行过程中,如果你开启了<code>日志</code>,主服务器会将binlog日志同步到从服务器的relaylog日志上，从服务器再根据repaylog日志文件复原成数据，再将数据执行并恢复到从服务器的数据库当中 每个从服务器从主服务器接收主服务器已经记录到其二进制日志的保存的更新。当一个从服务器连接主服务器时,它通知主服务器从服务器在日志中读取的最后一次成功更新的位置。从服务器接收从那时起发生的任何更新,并在本机上执行相同的更新。然后封锁并等待主服务器通知新的更新。从服务器执行备份不会干扰主服务器,在备份过程中主服务器可以继续处理更新。<br /></p>
</li>
<li>
<p>Gtid方式（MySQL&gt;=5.7推荐使用）：<br>
基于GTID的复制中,从库会告知主库已经执行的事务的GTID的值,然后主库会将所有未执行的事务的GTID的列表返回给从库,并且可以保证同一个事务只在指定的从库执行一次。</p>
</li>
</ol>
<h2 id="主从复制binlog与relaylog">主从复制binlog与relaylog</h2>
<blockquote>
<p>主从复制的步骤</p>
</blockquote>
<ul>
<li>MySql主库在事务提交时会把数据变更作为事件记录在二进制日志Binlog中；</li>
<li>主库推送二进制日志文件Binlog中的事件到从库的中继日志Relay Log中，之后从库根据中继日志重做数据变更操作，通过逻辑复制来达到主库和从库的数据一致性</li>
<li>MySql通过三个线程来完成主从库间的数据复制，其中Binlog Dump线程跑在主库上，I/O线程和SQL线程跑着从库上</li>
<li>当在从库上启动复制时，首先创建I/O线程连接主库，主库随后创建Binlog Dump线程读取数据库事件并发送给I/O线程，I/O线程获取到事件数据后更新到从库的中继日志Relay Log中去，之后从库上的SQL线程读取中继日志Relay Log中更新的数据库事件并应用，如下图所示</li>
</ul>
<p>综上用图表示如下</p>
<p><img src="https://noback.upyun.com/ki1wsc5yh3.png" alt="ki1wsc5yh3.png">​</p>
<p>什么是数据库日志</p>
<p>mysql会根据主服务器的动作,将主服务器中所有的DDL以及DML操作都通过二进制日志记录到本地的bin.log文件上, 其中DDL语句中需要去除掉查询语句和没有update成功的语句</p>
<p>什么是DDL语句</p>
<p>建库、建表、设置约束等：create\drop\alter 等操作叫做DDL语句, example</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 创建数据库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">hncu</span><span class="w"> </span><span class="nb">CHARACTER</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 创建表格
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">use</span><span class="w"> </span><span class="n">hncu</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">stud</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">age</span><span class="w"> </span><span class="nb">int</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 更改表结构(设置约束)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">desc</span><span class="w"> </span><span class="n">stud</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="err">查看表结构</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">stud</span><span class="w"> </span><span class="k">drop</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">age</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">stud</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="nb">int</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 删除表、删除数据库
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">stud</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">drop</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">hncu</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>什么是DML语句</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 主要指数据的增删查改: Select\delete\update\insert\call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">stud</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">age</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">stud</span><span class="p">;</span><span class="w"> </span><span class="o">//</span><span class="err">查询指定的列</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="err">姓名</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="err">年龄</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">stud</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>mysql复制的几种方式</p>
<ol>
<li>异步复制<br>
一个主库,一个或多个从库,数据异步同步到从库。</li>
<li>同步复制<br>
在MySQL cluster中特有的复制方式。</li>
<li>半同步复制<br>
在异步复制的基础上,确保任何一个主库上的事物在提交之前至少有一个从库已经收到该事物并日志记录下来。</li>
<li>延迟复制<br>
在异步复制的基础上,人为设定主库和从库的数据同步延迟时间,即保证数据延迟至少是这个参数。</li>
</ol>
<p>mysql复制的几种形式</p>
<ol>
<li><strong>基于语句的复制</strong>：在主服务器上执行的SQL语句,在从服务器上执行同样的语句。MySQL默认采用基于语句的复制,效率比较高。 一旦发现没法精确复制时,会自动选着基于行的复制</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">binlog_format</span><span class="o">=</span>Statement
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li><strong>基于行的复制</strong>：把改变的内容复制过去,而不是把命令在从服务器上执行一遍. 从mysql5.0开始支持</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">binlog_format</span><span class="o">=</span>Row
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li><strong>混合类型的复制</strong>：默认采用基于语句的复制,一旦发现基于语句的无法精确的复制时,就会采用基于行的复制。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">binlog_format</span><span class="o">=</span>Mixed
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="slave_io_running与slave_sql_running-状态异常">Slave_IO_Running与Slave_SQL_Running 状态异常</h3>
<ol>
<li>网络异常 主从机不互通</li>
<li>密码不对，远程账号密码不正确</li>
<li>pos不对， 通过show master status查看pos</li>
</ol>
<h2 id="基于二进制日志点的异步复制解决方案">基于二进制日志点的异步复制解决方案</h2>
<p>我们在MySQL中配置了主从之后,</p>
<ul>
<li>只要我们对Master节点进行了写操作,这个操作将会被保存到MySQL的binary-log（bin-log）日志当中, 这些记录叫做二进制日志事件,binary log events）</li>
<li>slave 将 master 的 binary log events 拷贝到它的中继日志(relay log)</li>
<li>slave 重做中继日志中的事件,将改变反映它自己的数据。</li>
</ul>
<p><img src="http://noback.upyun.com/2020-06-08-08-51-22.png" alt="2020-06-08-08-51-22"></p>
<p>两个线程的主要作用</p>
<ul>
<li>I/O线程：该线程链接到master机器,master机器的binlog发送到slave的时候,IO线程会将该日志内容写在本地的中继日志（Relay log）中。</li>
<li>SQL线程：该线程读取中继日志中的内容,并且根据中继日志中的内容对Slave数据库做相应的操作。<br>
可能造成的问题：在写请求相当多的情况下,可能会造成Slave数据和Master数据不一致的情况,这是因为日志传输过程中的短暂延迟、或者写命令较多,系统速度不匹配造成的。<br>
这大致就是MySQL主从同步的原理,真正在其中起到作用的实际上就是这两个日志文件,binlog和中继日志（Relay log）。</li>
</ul>
<p>创建两个mysql容器 因为配置文件我们后面要做修改,所以需要外面挂载进去<br>
设置配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir /hzj/mysql
</span></span><span class="line"><span class="cl"><span class="o">[</span>mysqld<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">datadir</span><span class="o">=</span>/var/lib/mysql
</span></span><span class="line"><span class="cl"><span class="nv">socket</span><span class="o">=</span>/var/lib/mysql/mysql.sock
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ====== 主从复制配置文件</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">server-id <span class="o">=</span> <span class="m">1</span>            <span class="c1"># 服务器 id 号,不要和其他服务器重复</span>
</span></span><span class="line"><span class="cl">log-bin<span class="o">=</span>mysql-bin     <span class="c1"># 开启二进制日志</span>
</span></span><span class="line"><span class="cl"><span class="nv">log_bin_index</span> <span class="o">=</span> mysql-bin.index    <span class="c1"># 索引二进制日志的文件名</span>
</span></span><span class="line"><span class="cl"><span class="nv">sync_binlog</span> <span class="o">=</span> <span class="m">1</span>      <span class="c1"># 设为1就是把MySql每次发生的修改和事件的日志即时同步到硬盘上</span>
</span></span><span class="line"><span class="cl"><span class="nv">binlog_format</span> <span class="o">=</span> Row     <span class="c1"># 复制模式 Statement, Row, mixed 这里是基于行的复制</span>
</span></span><span class="line"><span class="cl"><span class="nv">skip_slave_start</span> <span class="o">=</span> <span class="m">1</span>     <span class="c1"># 防止从服务器在崩溃后自动开启,以给你足够的时间修复。</span>
</span></span><span class="line"><span class="cl"><span class="nv">max_binlog_size</span> <span class="o">=</span> 200M     <span class="c1"># 指定二进制日志的大小</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">binlog-do-db <span class="o">=</span> datafordata
</span></span><span class="line"><span class="cl"><span class="c1"># Disabling symbolic-links is recommended to prevent assorted security risks</span>
</span></span><span class="line"><span class="cl">symbolic-links<span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Recommended in standard MySQL setup</span>
</span></span><span class="line"><span class="cl">sql-mode<span class="o">=</span>NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>mysqld_safe<span class="o">]</span>
</span></span><span class="line"><span class="cl">log-error<span class="o">=</span>/var/log/mysqld.log
</span></span><span class="line"><span class="cl">pid-file<span class="o">=</span>/var/run/mysqld/mysqld.pid
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># slave.cnf</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>mysqld<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># read_rnd_buffer_size = 2M</span>
</span></span><span class="line"><span class="cl"><span class="nv">datadir</span><span class="o">=</span>/var/lib/mysql
</span></span><span class="line"><span class="cl"><span class="nv">socket</span><span class="o">=</span>/var/lib/mysql/mysql.sock
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ======= 主从赋值配置文件</span>
</span></span><span class="line"><span class="cl">server-id <span class="o">=</span> <span class="m">2</span>  <span class="c1"># 服务器 id 号,不要和其他服务器重复</span>
</span></span><span class="line"><span class="cl"><span class="nv">read_only</span> <span class="o">=</span> <span class="m">1</span>  <span class="c1"># 让从服务器只读,可以防止有人误从服务器插入数据,导致主从数据不一致。·</span>
</span></span><span class="line"><span class="cl">log-bin<span class="o">=</span>mysql-bin <span class="c1"># 开启二进制日志</span>
</span></span><span class="line"><span class="cl"><span class="nv">log_bin_index</span> <span class="o">=</span> mysql-bin.index# 索引二进制日志的文件名
</span></span><span class="line"><span class="cl"><span class="nv">log_slave_updates</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">relay_log</span> <span class="o">=</span> mysql-relay-bin  <span class="c1"># 中继日志·</span>
</span></span><span class="line"><span class="cl"><span class="nv">relay_log_index</span> <span class="o">=</span> mysql-relay-bin.index
</span></span><span class="line"><span class="cl"><span class="nv">skip_slave_start</span> <span class="o">=</span> <span class="m">1</span>  <span class="c1"># 防止从服务器在崩溃后自动开启,以给你足够的时间修复。·</span>
</span></span><span class="line"><span class="cl"><span class="nv">max_binlog_size</span> <span class="o">=</span> 200M   <span class="c1"># 指定二进制日志的大小</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">binlog-do-db <span class="o">=</span> datafordata
</span></span><span class="line"><span class="cl"><span class="c1"># Disabling symbolic-links is recommended to prevent assorted security risks</span>
</span></span><span class="line"><span class="cl">symbolic-links<span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Recommended in standard MySQL setup</span>
</span></span><span class="line"><span class="cl">sql-mode<span class="o">=</span>NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>mysqld_safe<span class="o">]</span>
</span></span><span class="line"><span class="cl">log-error<span class="o">=</span>/var/log/mysqld.log
</span></span><span class="line"><span class="cl">pid-file<span class="o">=</span>/var/run/mysqld/mysqld.pid
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 1. 主从备份相关配置 - 从服务器</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 不在这里配置主服务器信息,而是通过命令来配置</span>
</span></span><span class="line"><span class="cl">server-id <span class="o">=</span> <span class="m">2</span> <span class="c1"># 服务器 id 号,不要和其他服务器重复</span>
</span></span><span class="line"><span class="cl"><span class="nv">read_only</span> <span class="o">=</span> <span class="m">1</span> <span class="c1"># 让从服务器只读,可以防止有人误从服务器插入数据,导致主从数据不一致。·</span>
</span></span><span class="line"><span class="cl">log-bin<span class="o">=</span>mysql-bin <span class="c1"># 开启二进制日志</span>
</span></span><span class="line"><span class="cl"><span class="nv">log_bin_index</span> <span class="o">=</span> mysql-bin.index# 索引二进制日志的文件名
</span></span><span class="line"><span class="cl"><span class="nv">log_slave_updates</span> <span class="o">=</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">relay_log</span> <span class="o">=</span> mysql-relay-bin <span class="c1"># 中继日志·</span>
</span></span><span class="line"><span class="cl"><span class="nv">relay_log_index</span> <span class="o">=</span> mysql-relay-bin.index
</span></span><span class="line"><span class="cl"><span class="nv">skip_slave_start</span> <span class="o">=</span> <span class="m">1</span> <span class="c1"># 防止从服务器在崩溃后自动开启,以给你足够的时间修复。·</span>
</span></span><span class="line"><span class="cl"><span class="nv">max_binlog_size</span> <span class="o">=</span> 200M  <span class="c1"># 指定二进制日志的大小</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 以下配置是为了方便以后,从库切换为主库</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1.1 需要同步的二进制数据库名</span>
</span></span><span class="line"><span class="cl">binlog-do-db <span class="o">=</span> datafordata
</span></span><span class="line"><span class="cl"><span class="c1"># 1.2 不同步的二进制数据库名,如果不设置可以将其注释掉</span>
</span></span><span class="line"><span class="cl"><span class="c1"># binlog-ignore-db = information_schema</span>
</span></span><span class="line"><span class="cl"><span class="c1"># binlog-ignore-db = mysql</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker pull mysql:5.7
</span></span><span class="line"><span class="cl">docker run -p 3305:3306 --name mysql-slave -v /root/hzj/hzj/mysql/slave.cnf:/etc/mysql/conf.d/slave.cnf -e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>upyun123 -itd mysql:5.7
</span></span><span class="line"><span class="cl">docker run -p 3306:3306 --name mysql-master -v /root/hzj/hzj/mysql/master.cnf:/etc/mysql/conf.d/master.cnf -e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>upyun123 -itd mysql:5.7
</span></span></code></pre></td></tr></table>
</div>
</div><p>进入容器配置远程用户</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 主机</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -it mysql-master /bin/bash
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; mysql -u root -p
</span></span><span class="line"><span class="cl"><span class="c1"># 修改本地root密码</span>
</span></span><span class="line"><span class="cl">&gt; ALTER USER <span class="s1">&#39;root&#39;</span>@<span class="s1">&#39;localhost&#39;</span> IDENTIFIED BY <span class="s1">&#39;upyun123&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 创建远程登录用户</span>
</span></span><span class="line"><span class="cl">&gt; CREATE USER <span class="s1">&#39;hzj&#39;</span>@<span class="s1">&#39;%&#39;</span> IDENTIFIED WITH mysql_native_password BY <span class="s1">&#39;upyun123&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">&gt; GRANT ALL PRIVILEGES ON *.* TO <span class="s1">&#39;hzj&#39;</span>@<span class="s1">&#39;%&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 备机</span>
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -it mysql-slave /bin/bash
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; mysql -u root -p
</span></span><span class="line"><span class="cl"><span class="c1"># 修改本地root密码</span>
</span></span><span class="line"><span class="cl">&gt; ALTER USER <span class="s1">&#39;root&#39;</span>@<span class="s1">&#39;localhost&#39;</span> IDENTIFIED BY <span class="s1">&#39;upyun123&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 创建远程登录用户</span>
</span></span><span class="line"><span class="cl">&gt; CREATE USER <span class="s1">&#39;hzj&#39;</span>@<span class="s1">&#39;%&#39;</span> IDENTIFIED WITH mysql_native_password BY <span class="s1">&#39;upyun123&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">&gt; GRANT ALL PRIVILEGES ON *.* TO <span class="s1">&#39;hzj&#39;</span>@<span class="s1">&#39;%&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="http://noback.upyun.com/2020-06-05-15-30-18.png" alt="2020-06-05-15-30-18"></p>
<p>初始化主机上的内容,并插入内容,模拟需要备份的内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">datafordata</span><span class="w">  </span><span class="nb">character</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">utf8mb4</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">use</span><span class="w"> </span><span class="n">datafordata</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">t_temp</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;主键ID&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="o">`</span><span class="k">comment</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;备注&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="o">`</span><span class="n">create_time</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="o">`</span><span class="n">update_time</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="err">插入数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">datafordata</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">t_temp</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">comment</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">create_time</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">update_time</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;helloworld&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img src="http://noback.upyun.com/2020-06-05-15-39-52.png" alt="2020-06-05-15-39-52"></p>
<p>更新完毕以后,查看主从机器中主机的状态<br>
<img src="http://noback.upyun.com/2020-06-05-17-02-43.png" alt="2020-06-05-17-02-43"><br>
<img src="http://noback.upyun.com/2020-06-05-18-21-19.png" alt="2020-06-05-18-21-19"></p>
<p>参数介绍</p>
<ul>
<li>File: mysql-bin.000033 #当前记录的日志</li>
<li>Position: 337523 #日志中记录的位置</li>
<li>Binlog_Do_DB:</li>
<li>Binlog_Ignore_DB:</li>
</ul>
<p>在从机上设置同步目标</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">change  master to <span class="nv">master_host</span><span class="o">=</span><span class="s1">&#39;10.0.6.55&#39;</span>,MASTER_PORT<span class="o">=</span>3306,master_user<span class="o">=</span><span class="s1">&#39;root&#39;</span>,master_password<span class="o">=</span><span class="s1">&#39;upyun123&#39;</span>,master_log_file<span class="o">=</span><span class="s1">&#39;mysql-bin.000003&#39;</span>,master_log_pos<span class="o">=</span>4210<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中master_log_pos和master_log_file是在主机上面使用<code>show master status </code> 查看对应的log名字和log大小<br>
开启同步</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">start slave<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 查看同步状态</span>
</span></span><span class="line"><span class="cl">show slave status<span class="se">\G</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="http://noback.upyun.com/2020-06-05-18-28-14.png" alt="2020-06-05-18-28-14"><br>
这里面如果是yes表示正在同步了,如果是no则表示没有同步</p>
<p><font color='red'>主从备份的时候要保证两个数据库的数据结构是一一致的</font></p>
<h2 id="主从同步进阶版--读写分离">主从同步进阶版&ndash;读写分离</h2>
<p><img src="http://noback.upyun.com/2020-06-08-08-53-53.png" alt="2020-06-08-08-53-53"></p>
<h2 id="golang-从程序角度看如何实现读写分离">Golang 从程序角度看如何实现读写分离</h2>
<h2 id="master和salve数据库的数据不一致解决方案">master和salve数据库的数据不一致解决方案</h2>
<p>主从数据库的数据要保持一致,不然主从同步会出现bug..<br>
如果主数据库中已经存在数据,有两种解决方案.</p>
<ul>
<li>第一种方案是选择忽略主库之前的数据,不做处理。这种方案只适用于不重要的可有可无的数据,并且业务上能够容忍主从库数据不一致的场景。</li>
<li>第二种方案是对主库的数据进行备份,然后将主数据库中导出的数据导入到从数据库,然后再开启主从复制,以此来保证主从数据库数据一致</li>
</ul>
<h3 id="mysqldump-冷备份">mysqldump 冷备份</h3>
<p>在之前就备份好数据库,使用mysqldump备份数据库<br>
mysqldump是mysql原生自带很好用的逻辑备份工具<br>
备份的基本流程如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">1.调用FTWRL<span class="o">(</span>flush tables with <span class="nb">read</span> lock<span class="o">)</span>,全局禁止读写
</span></span><span class="line"><span class="cl">2.开启快照读,获取此时的快照<span class="o">(</span>仅对innodb表起作用<span class="o">)</span>
</span></span><span class="line"><span class="cl">3.备份非innodb表数据<span class="o">(</span>*.frm,*.myi,*.myd等<span class="o">)</span>
</span></span><span class="line"><span class="cl">4.非innodb表备份完毕后,释放FTWRL锁
</span></span><span class="line"><span class="cl">5.逐一备份innodb表数据
</span></span><span class="line"><span class="cl">6.备份完成
</span></span></code></pre></td></tr></table>
</div>
</div><p>常用备份参数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">-A <span class="c1">#备份全库</span>
</span></span><span class="line"><span class="cl">-B <span class="c1">#备某一个数据库下的所有表</span>
</span></span><span class="line"><span class="cl">-R <span class="c1">#备份存储过程和函数数据</span>
</span></span><span class="line"><span class="cl">--triggers <span class="c1"># 备份触发器数据</span>
</span></span><span class="line"><span class="cl">--master-data <span class="o">=</span> <span class="o">{</span>1<span class="p">|</span>2<span class="o">}</span> <span class="c1"># 告诉你备份后时刻的binlog位置 ,如果等于1,则将其打印为CHANGE MASTER命令; 如果等于2,那么该命令将以注释符号为前缀。</span>
</span></span><span class="line"><span class="cl">--single-transaction <span class="c1"># 对innodb引擎进行热备</span>
</span></span><span class="line"><span class="cl">-F, --flush-logs <span class="c1"># 刷新binlog日志</span>
</span></span><span class="line"><span class="cl">-x, --lock-all-tables <span class="c1"># 锁定所有数据库的所有表。这是通过在整个转储期间采用全局读锁来实现的</span>
</span></span><span class="line"><span class="cl">-l, --lock-tables <span class="c1"># 锁定所有表以供读取</span>
</span></span><span class="line"><span class="cl">-d,  <span class="c1"># 仅表结构</span>
</span></span><span class="line"><span class="cl">-t, <span class="c1"># 仅数据</span>
</span></span><span class="line"><span class="cl">--compact <span class="c1">#减少无用数据输出(调试)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysqldump -A -R --triggers --master-data<span class="o">=</span><span class="m">2</span> --single-transaction <span class="p">|</span>gzip &gt;/opt/all_<span class="k">$(</span>date +%F<span class="k">)</span>.sql.gz 
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 1.锁定数据库,保证在同步的过程中不会有新的数据插入</span>
</span></span><span class="line"><span class="cl">flush tables with <span class="nb">read</span> lock<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2. 使用mysqldump备份数据库</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost data<span class="o">]</span><span class="c1"># cd /data/db_backup/</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@localhost db_backup<span class="o">]</span><span class="c1">#  mysqldump -uroot -p --master-data=1 --single-transaction --routines --triggers --events  --all-databases &gt; all.sql</span>
</span></span><span class="line"><span class="cl">Enter password
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3.解除主数据库的锁定</span>
</span></span><span class="line"><span class="cl">unlock tables<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 4. 把数据全量导入slave数据库,保证主从数据一致</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="xtrabackup-热备份">Xtrabackup 热备份</h3>
<p>Xtrabackup是一个开源的免费的热备工具,在Xtrabackup包中主要有Xtrabackup和innobackupex两个工具。xtrabackup 是用来备份 InnoDB 表的,不能备份非 InnoDB 表,和 mysqld server 没有交互；innobackupex 脚本用来备份非 InnoDB 表,同时会调用 xtrabackup 命令来备份 InnoDB 表,还会和 mysqld server 发送命令进行交互,如加读锁（FTWRL）、获取位点（SHOW SLAVE STATUS）等。简单来说,innobackupex 在 xtrabackup 之上做了一层封装。</p>
<p>安装完成xtarbackup之后,会有下面4个工具</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">usr
</span></span><span class="line"><span class="cl">├── bin
</span></span><span class="line"><span class="cl">│   ├── innobackupex  <span class="c1"># 备份innodb表</span>
</span></span><span class="line"><span class="cl">│   ├── xbcrypt  <span class="c1"># 备份加密</span>
</span></span><span class="line"><span class="cl">│   ├── xbstream  <span class="c1"># 流式备份</span>
</span></span><span class="line"><span class="cl">│   └── xtrabackup  <span class="c1"># 备份非innodb表</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="备份流程">备份流程</h4>
<p><img src="http://noback.upyun.com/2020-06-08-10-54-05.png" alt="2020-06-08-10-54-05"><br>
备份过程<br>
<img src="http://noback.upyun.com/2020-06-08-10-55-13.png" alt="2020-06-08-10-55-13"><br>
恢复过程<br>
<img src="http://noback.upyun.com/2020-06-08-10-44-07.png" alt="2020-06-08-10-44-07"></p>
<ol>
<li>innobackupex 在启动后,会先 fork 一个进程,启动 xtrabackup进程,然后就等待 xtrabackup 备份完 ibd 数据文件；</li>
<li>xtrabackup 在备份 InnoDB 相关数据时,是有2种线程的,1种是 redo 拷贝线程,负责拷贝 redo 文件,1种是 ibd 拷贝线程,负责拷贝 ibd 文件；redo 拷贝线程只有一个,在 ibd 拷贝线程之前启动,在 ibd 线程结束后结束。xtrabackup 进程开始执行后,先启动 redo 拷贝线程,从最新的 checkpoint 点开始顺序拷贝 redo 日志；然后再启动 ibd 数据拷贝线程,在 xtrabackup 拷贝 ibd 过程中,innobackupex 进程一直处于等待状态（等待文件被创建）</li>
<li>xtrabackup 拷贝完成idb后,通知 innobackupex（通过创建文件）,同时自己进入等待（redo 线程仍然继续拷贝）;</li>
<li>innobackupex 收到 xtrabackup 通知后,执行FLUSH TABLES WITH READ LOCK (FTWRL),取得一致性位点,然后开始备份非 InnoDB 文件（包括 frm、MYD、MYI、CSV、opt、par等）。拷贝非 InnoDB 文件过程中,因为数据库处于全局只读状态,如果在业务的主库备份的话,要特别小心,非 InnoDB 表（主要是MyISAM）比较多的话整库只读时间就会比较长,这个影响一定要评估到。</li>
<li>当 innobackupex 拷贝完所有非 InnoDB 表文件后,通知 xtrabackup（通过删文件） ,同时自己进入等待（等待另一个文件被创建）；</li>
<li>xtrabackup 收到 innobackupex 备份完非 InnoDB 通知后,就停止 redo 拷贝线程,然后通知 innobackupex redo log 拷贝完成（通过创建文件）；</li>
<li>innobackupex 收到 redo 备份完成通知后,就开始解锁,执行 UNLOCK TABLES；</li>
<li>最后 innobackupex 和 xtrabackup 进程各自完成收尾工作,如资源的释放、写备份元数据信息等,innobackupex 等待 xtrabackup 子进程结束后退出。</li>
</ol>
<p>在上面描述的文件拷贝,都是备份进程直接通过操作系统读取数据文件的,只在执行 SQL 命令时和数据库有交互,基本不影响数据库的运行,在备份非 InnoDB 时会有一段时间只读（如果没有MyISAM表的话,只读时间在几秒左右）,在备份 InnoDB 数据文件时,对数据库完全没有影响,是真正的热备。</p>
<p>InnoDB 和非 InnoDB 文件的备份都是通过拷贝文件来做的,但是实现的方式不同,前者是以page为粒度做的(xtrabackup),后者是 cp 或者 tar 命令(innobackupex),xtrabackup 在读取每个page时会校验 checksum 值,保证数据块是一致的,而 innobackupex 在 cp MyISAM 文件时已经做了flush（FTWRL）,磁盘上的文件也是完整的,所以最终备份集里的数据文件都是写入完整的。</p>
<p>&mdash; <a href="http://mysql.taobao.org/monthly/2016/03/07/">http://mysql.taobao.org/monthly/2016/03/07/</a></p>
<h4 id="安装xtrabackup">安装xtrabackup</h4>
<ul>
<li>下载安装包<br>
网址是https://www.percona.com/downloads/ 我这里使用的是2.4.14版本。</li>
<li>下载依赖包<br>
然后下载依赖包,网址是http://rpmfind.net/linux/atrpms/el6-x86_64/atrpms/stable/libev-4.04-2.el6.x86_64.rpm。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mdkir /root/package <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /root/package
</span></span><span class="line"><span class="cl">wget Percona-XtraBackup-2.4.14-ref675d4-el7-x86_64-bundle.tar
</span></span><span class="line"><span class="cl">wget http://rpmfind.net/linux/atrpms/el6-x86_64/atrpms/stable/libev-4.04-2.el6.x86_64.rpm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">rpm -ivh libev-4.04-2.el6.x86_64.rpm
</span></span><span class="line"><span class="cl">tar -xf Percona-XtraBackup-2.4.14-ref675d4-el7-x86_64-bundle.tar
</span></span><span class="line"><span class="cl">yum -y install percona-xtrabackup-24-2.4.14-1.el7.x86_64.rpm
</span></span></code></pre></td></tr></table>
</div>
</div><p><font color='red'>xtrabackup是根据数据库的配置文件来查找数据库的,默认情况下指向/etc/my.cnf</font></p>
<h4 id="使用xtrabackup全量备份">使用xtrabackup全量备份</h4>
<p>在备份数据库时会涉及到两个用户：系统用户与数据库内部的用户。<br>
　　系统用户需要在datadir（配置文件内设置的目录）上具有读写执行权限（rwx）。而数据库内部用户需要：RELOAD和LOCK TABLES权限,为了执行FLUSH TABLES WITH READ LOCK；REPLICATION CLIENT权限,为了获取binary log（二进制日志文件）位置；CREATE TABLESPACE权限,为了导入表,用户表级别的恢复；SUPER权限,为了在slave环境下备份用来启动和关闭slave线程。</p>
<p>常用参数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">--user<span class="o">=[</span>数据库用户<span class="o">]</span>    以什么用户身份进行操作
</span></span><span class="line"><span class="cl">--password<span class="o">=[</span>密码<span class="o">]</span>    数据库用户的密码
</span></span><span class="line"><span class="cl">--port<span class="o">=[</span>端口号<span class="o">]</span>    数据库的端口号,默认3306
</span></span><span class="line"><span class="cl">--stream<span class="o">=[</span>tar<span class="p">|</span>xbstream<span class="o">]</span>　　打包（数据流）
</span></span><span class="line"><span class="cl">--defaults-file<span class="o">=[</span>配置文件<span class="o">]</span>　　指定默认配置文件,默认读取/etc/my.cnf
</span></span><span class="line"><span class="cl">--no-timestamp　　不创建时间戳文件,而改用目的地址（可以自动创建）
</span></span><span class="line"><span class="cl">--copy-back　　备份还原的主要选项
</span></span><span class="line"><span class="cl">--incremental　　使用增量备份,默认使用的完整备份
</span></span><span class="line"><span class="cl">--apply-log 应用数据
</span></span><span class="line"><span class="cl">--incremental-basedir<span class="o">=[</span>地址<span class="o">]</span>　　与--incremental选项联合使用,该参数指定上一级备份的地址来做增量备份
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 复制数据库中的内容</span>
</span></span><span class="line"><span class="cl">innobackupex --user<span class="o">=</span>root --password<span class="o">=</span><span class="m">123456</span> ./db_backup/  <span class="c1"># 会打印每一个备份的步骤</span>
</span></span><span class="line"><span class="cl">innobackupex --user<span class="o">=</span>root --password<span class="o">=</span><span class="m">123456</span> ./db_backup/ 2&gt;&gt;./db_backup/backup.log　　<span class="c1"># 将输出内容丢到黑洞如果不想要输出信息,可以将输出信息重定向到指定文件或黑洞文件中 </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果mysql是挂在docker里面的 需要指定IP和端口 本机也需要</span>
</span></span><span class="line"><span class="cl">innobackupex --user<span class="o">=</span>root --password<span class="o">=</span><span class="m">123456</span> --host<span class="o">=</span>10.0.6.55 --port<span class="o">=</span><span class="m">3303</span> ./db_backup/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ==== nc方法 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 流式备份,完成远程主机间的全量备份</span>
</span></span><span class="line"><span class="cl"><span class="c1"># master端</span>
</span></span><span class="line"><span class="cl">innobackupex --user<span class="o">=</span>root --password<span class="o">=</span><span class="m">123456</span> --host<span class="o">=</span>10.0.6.55 --port<span class="o">=</span><span class="m">3303</span> --stream<span class="o">=</span>tar ./ <span class="p">|</span> nc 10.0.6.35 <span class="m">9998</span>
</span></span><span class="line"><span class="cl"><span class="c1"># slave 端</span>
</span></span><span class="line"><span class="cl">nc -l <span class="m">9998</span> <span class="p">|</span> tar -ixvf -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ==== 官方的xbstream</span>
</span></span><span class="line"><span class="cl">innobackupex  --user<span class="o">=</span>root --password<span class="o">=</span><span class="s2">&#34;upyun123&#34;</span> --port<span class="o">=</span><span class="m">3303</span> --host<span class="o">=</span>10.0.6.55 --slave-info --parallel<span class="o">=</span><span class="m">16</span>  --stream<span class="o">=</span>xbstream ./ 2&gt;/data/xtrabackup_log.txt <span class="p">|</span> pv -q -L40m <span class="p">|</span> ssh lily@172.26.1.245 <span class="s2">&#34; cat - |  xbstream -x -C /data/innobackup&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 备份完成后会在/db_backup文件夹下面产生一个根据日期来创建的备份文件夹</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 自定义备份文件名</span>
</span></span><span class="line"><span class="cl">innobackupex --user<span class="o">=</span>root --password<span class="o">=</span><span class="m">123456</span> --no-timestamp ./db_backup/test/ 2&gt;&gt;./db_backup/backup.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 需要清除数据,不然出现报错</span>
</span></span><span class="line"><span class="cl">systemctl stop mysqld
</span></span><span class="line"><span class="cl">rm -rf /var/lib/mysql/*　　<span class="c1">#危险操作,请在测试环境测试</span>
</span></span><span class="line"><span class="cl">innobackupex --apply-log ./db_backup/ --use-memory<span class="o">=</span>16G  
</span></span><span class="line"><span class="cl">chown -R mysql:mysql /var/lib/mysql　<span class="c1"># 重新授权</span>
</span></span><span class="line"><span class="cl">systemctl start mysqld
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用xtrabackup增量备份">使用xtrabackup增量备份</h4>
<p>待填<br>
<a href="https://www.centos.bz/2017/09/xtrabackup-backup-mysql-innodb/">https://www.centos.bz/2017/09/xtrabackup-backup-mysql-innodb/</a><br>
cnblogs.com/zhoujinyi/p/4088866.html<br>
<a href="https://www.cnblogs.com/gaogao67/p/10980642.html">https://www.cnblogs.com/gaogao67/p/10980642.html</a></p>
<h4 id="xtrabackup-流式备份">xtrabackup 流式备份</h4>
<p>如果需要将 机器上面的备份数据发送到远程机器,或者快速搭建主从,可以采用流式备份。<br>
例如：这里将172.26.1.3的数据发送到 172.26.1.245 并做成主从同步。  master: 172.26.1.3  slave:172.26.1.245<br>
172.26.1.3 备份之前需要先关闭多线程复制,否则会报错</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mysql&gt; show variables like <span class="s1">&#39;%worker%&#39;</span>
</span></span><span class="line"><span class="cl">    -&gt; <span class="p">;</span>
</span></span><span class="line"><span class="cl">+------------------------+-------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> Variable_name          <span class="p">|</span> Value <span class="p">|</span>
</span></span><span class="line"><span class="cl">+------------------------+-------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> slave_parallel_workers <span class="p">|</span> <span class="m">0</span>     <span class="p">|</span>
</span></span><span class="line"><span class="cl">+------------------------+-------+
</span></span><span class="line"><span class="cl"><span class="m">1</span> row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; <span class="nb">set</span> global <span class="nv">slave_parallel_workers</span><span class="o">=</span>0<span class="p">;</span>
</span></span><span class="line"><span class="cl">Query OK, <span class="m">0</span> rows affected <span class="o">(</span>0.00 sec<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># master端 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 主要操作就是打包本地的数据,使用xbstream传输到对端机器,然后使用ssh登录对端 并且接收</span>
</span></span><span class="line"><span class="cl">innobackupex  --user<span class="o">=</span>root --password<span class="o">=</span><span class="s2">&#34;upyun123&#34;</span> --port<span class="o">=</span><span class="m">3303</span> --host<span class="o">=</span>10.0.6.55 --slave-info --parallel<span class="o">=</span><span class="m">16</span>  --stream<span class="o">=</span>xbstream ./ 2&gt;/data/xtrabackup_log.txt <span class="p">|</span> pv -q -L40m <span class="p">|</span> ssh lily@172.26.1.245 <span class="s2">&#34; cat - |  xbstream -x -C /data/innobackup&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注：这里的 172.26.1.245 是远程机器的ip</p>
<p>&ndash;slave-info： 备份目录下会多生成一个xtrabackup_slave_info文件,文件内容类似于:CHANGE MASTER TO MASTER_LOG_FILE=&rsquo;&rsquo;, MASTER_LOG_POS=0。<br>
这个参数适用的场景：假设有主库A和从库B,目前想再添加一台备库C,并让备库C以主库A为master；因为主库A是生产库,压力一般比较大,所以就在备库B上备份一个数据库,然后把这个备份拿到C服务器上,并导入到C库,接下来再在C服务器上执行change master的命令：其中master_host是A的ip,而master_log_file和master_log_pos就是这个xtrabackup_slave_info里面的值。</p>
<h4 id="备份恢复">备份恢复</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">恢复（在远程机器172.26.1.245执行）
</span></span><span class="line"><span class="cl">1,拷贝master机器的/etc/my.cnf 文件,并修改server_id。
</span></span><span class="line"><span class="cl">2,将172.26.1.245做成172.26.1.3的从库, 从 /data/innobackup/xtrabackup_binlog_info 文件里面读取binlog和position信息。
</span></span><span class="line"><span class="cl"><span class="c1">#  cat /data/innobackup/xtrabackup_binlog_info </span>
</span></span><span class="line"><span class="cl">mysql-bin.000066 <span class="m">94839444</span>
</span></span><span class="line"><span class="cl">mysql&gt; CHANGE MASTER TO <span class="nv">MASTER_HOST</span><span class="o">=</span><span class="s1">&#39;172.26.1.3&#39;</span>,MASTER_USER<span class="o">=</span><span class="s1">&#39;repl&#39;</span>,MASTER_PASSWORD<span class="o">=</span><span class="s1">&#39;xxxxxx&#39;</span>,MASTER_AUTO_POSITION<span class="o">=</span>0,MASTER_LOG_FILE<span class="o">=</span><span class="s1">&#39;mysql-bin.000066&#39;</span>,MASTER_LOG_POS<span class="o">=</span>94839444<span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; start slave<span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="区别">区别</h4>
<p>Xtrabackup备份时不能备份表结构、触发器等等,也不能智能区分.idb数据文件。另外innobackupex还不能完全支持增量备份,需要和xtrabackup结合起来实现全备的功能。</p>
<h2 id="xtrabackup详解">xtrabackup详解</h2>
<p>记录一下xtrabackup的备份流程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 先备份</span>
</span></span><span class="line"><span class="cl">innobackupex --user<span class="o">=</span>hzj --password<span class="o">=</span>upyun123 --port<span class="o">=</span><span class="m">3303</span> --host<span class="o">=</span>10.0.6.55 ./
</span></span><span class="line"><span class="cl">cat /root/data/backup/2020-06-08_01-55-22/xtrabackup_checkpoints
</span></span><span class="line"><span class="cl"><span class="c1"># backup_type = full-backuped  # 这里提示backup 说明当前是备份的</span>
</span></span><span class="line"><span class="cl"><span class="c1"># from_lsn = 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to_lsn = 6110542</span>
</span></span><span class="line"><span class="cl"><span class="c1"># last_lsn = 6110542</span>
</span></span><span class="line"><span class="cl"><span class="c1"># compact = 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># recover_binlog_info = 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># flushed_lsn = 12501828</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 回滚 </span>
</span></span><span class="line"><span class="cl"><span class="c1"># 将全量备份后的内容拷贝到需要备份的从机器上进行备份</span>
</span></span><span class="line"><span class="cl">innobackupex --apply-log --use-memory<span class="o">=</span>32M /root/data/backup/2020-06-08_01-55-22/
</span></span><span class="line"><span class="cl"><span class="c1"># 查看文件状态</span>
</span></span><span class="line"><span class="cl">more xtrabackup_checkpoints
</span></span><span class="line"><span class="cl"><span class="c1"># backup_type = full-prepared # 已经准备完成</span>
</span></span><span class="line"><span class="cl"><span class="c1"># from_lsn = 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to_lsn = 2641979</span>
</span></span><span class="line"><span class="cl"><span class="c1"># last_lsn = 2641988</span>
</span></span><span class="line"><span class="cl"><span class="c1"># compact = 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># recover_binlog_info = 0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># flushed_lsn = 12501828</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 备份</span>
</span></span><span class="line"><span class="cl">innobackupex --copy-back /root/data/backup/2020-06-08_01-55-22/
</span></span><span class="line"><span class="cl">chown -R mysql.mysql /application/mysql/ <span class="c1"># 修改权限</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 重启数据库</span>
</span></span><span class="line"><span class="cl">systemctl restart mysqld
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="错误">错误</h2>
<h3 id="docker-mysql">docker mysql</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run -p 3306:3306 --name mysql-master -v /opt/docker_v/mysql/conf:./master.cnf -e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>upyun123 -itd mysql:5.7
</span></span><span class="line"><span class="cl">docker: Error response from daemon: invalid volume specification: <span class="s1">&#39;/opt/docker_v/mysql/conf:./master.cnf&#39;</span>: invalid mount config <span class="k">for</span> <span class="nb">type</span> <span class="s2">&#34;bind&#34;</span>: invalid mount path: <span class="s1">&#39;./master.cnf&#39;</span> mount path must be absolute.
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里挂在需要挂在绝对路径</p>
<h3 id="innobackupex-命令出错">innobackupex 命令出错</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@db01 mysql<span class="o">]</span><span class="c1"># innobackupex --user=root --password=123456 --defaults-file=/application/mysql/my.cnf /data/mysql/backup/</span>
</span></span><span class="line"><span class="cl">xtrabackup: Error: --defaults-file must be specified first on the <span class="nb">command</span> line
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@db01 mysql<span class="o">]</span><span class="c1"># innobackupex --defaults-file=/application/mysql/my.cnf --user=root --password=123456 /data/mysql/backup/</span>
</span></span><span class="line"><span class="cl"><span class="m">190817</span> 09:07:47 innobackupex: Starting the backup operation
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要把&ndash;defaults-file 作为第一个参数</p>
<h3 id="docker-mysql无法被innobackupex备份">docker-mysql无法被innobackupex备份</h3>
<p>使用过程中出现这个错误,这里做下记录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 如果mysql是挂在docker里面的 需要指定IP和端口 本机也需要</span>
</span></span><span class="line"><span class="cl">innobackup --user<span class="o">=</span>root --password<span class="o">=</span><span class="m">123456</span> --host<span class="o">=</span>10.0.6.55 --port<span class="o">=</span><span class="m">3303</span> ./db_backup/
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="docker-mysql重启数据库">docker-mysql重启数据库</h2>
<p>因为mysql的配置文件会根据需求去更改,所以最好把配置文件从本地挂载进去</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run -p 3306:3306 --name mysql-master -v /root/hzj/hzj/mysql/master.cnf:/etc/mysql/conf.d/master.cnf -e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>upyun123 -itd mysql:5.7
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt;c8328f40cfcb
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改配置文件重启数据库&mdash;&gt; 重启docekr容器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker restart c8328f40cfcb
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="docker-mysql运行">docker-mysql运行</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 挂在日志 数据和配置</span>
</span></span><span class="line"><span class="cl">docker run -p 3308:3306 --name mysql-slave <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-v /mydata/mysql-slave/log:/var/log/mysql <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-v /mydata/mysql-slave/data:/var/lib/mysql <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-v /mydata/mysql-slave/conf:/etc/mysql <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>root  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-d mysql:5.7
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="mysql-fake-data">mysql fake data</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ALTER USER <span class="s1">&#39;root&#39;</span>@<span class="s1">&#39;localhost&#39;</span> IDENTIFIED BY <span class="s1">&#39;upyun123&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">CREATE USER <span class="s1">&#39;hzj&#39;</span>@<span class="s1">&#39;%&#39;</span> IDENTIFIED WITH mysql_native_password BY <span class="s1">&#39;upyun123&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">GRANT ALL PRIVILEGES ON *.* TO <span class="s1">&#39;hzj&#39;</span>@<span class="s1">&#39;%&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">create database datafordata  character <span class="nb">set</span> utf8mb4<span class="p">;</span>
</span></span><span class="line"><span class="cl">use datafordata<span class="p">;</span>
</span></span><span class="line"><span class="cl">CREATE TABLE <span class="sb">`</span>t_temp<span class="sb">`</span> <span class="o">(</span>
</span></span><span class="line"><span class="cl">	<span class="sb">`</span>id<span class="sb">`</span> bigint<span class="o">(</span>20<span class="o">)</span> NOT NULL AUTO_INCREMENT COMMENT <span class="s1">&#39;主键ID&#39;</span>,
</span></span><span class="line"><span class="cl">	<span class="sb">`</span>comment<span class="sb">`</span> varchar<span class="o">(</span>10<span class="o">)</span> NOT NULL DEFAULT <span class="s1">&#39;&#39;</span> COMMENT <span class="s1">&#39;备注&#39;</span>,
</span></span><span class="line"><span class="cl">	<span class="sb">`</span>create_time<span class="sb">`</span> bigint<span class="o">(</span>20<span class="o">)</span> NOT NULL ,
</span></span><span class="line"><span class="cl">	<span class="sb">`</span>update_time<span class="sb">`</span> bigint<span class="o">(</span>20<span class="o">)</span> NOT NULL ,
</span></span><span class="line"><span class="cl">	PRIMARY KEY <span class="o">(</span><span class="sb">`</span>id<span class="sb">`</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span> <span class="nv">ENGINE</span><span class="o">=</span>InnoDB <span class="nv">AUTO_INCREMENT</span><span class="o">=</span><span class="m">1</span> DEFAULT <span class="nv">CHARSET</span><span class="o">=</span>utf8mb4<span class="p">;</span>
</span></span><span class="line"><span class="cl">INSERT INTO <span class="sb">`</span>datafordata<span class="sb">`</span>.<span class="sb">`</span>t_temp<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>id<span class="sb">`</span>, <span class="sb">`</span>comment<span class="sb">`</span>, <span class="sb">`</span>create_time<span class="sb">`</span>, <span class="sb">`</span>update_time<span class="sb">`</span><span class="o">)</span> VALUES <span class="o">(</span><span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;helloworld&#39;</span>, <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;1&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">INSERT INTO <span class="sb">`</span>datafordata<span class="sb">`</span>.<span class="sb">`</span>t_temp<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>id<span class="sb">`</span>, <span class="sb">`</span>comment<span class="sb">`</span>, <span class="sb">`</span>create_time<span class="sb">`</span>, <span class="sb">`</span>update_time<span class="sb">`</span><span class="o">)</span> VALUES <span class="o">(</span><span class="s1">&#39;2&#39;</span>, <span class="s1">&#39;helloworld&#39;</span>, <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;1&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">INSERT INTO <span class="sb">`</span>datafordata<span class="sb">`</span>.<span class="sb">`</span>t_temp<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>id<span class="sb">`</span>, <span class="sb">`</span>comment<span class="sb">`</span>, <span class="sb">`</span>create_time<span class="sb">`</span>, <span class="sb">`</span>update_time<span class="sb">`</span><span class="o">)</span> VALUES <span class="o">(</span><span class="s1">&#39;3&#39;</span>, <span class="s1">&#39;helloworld&#39;</span>, <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;1&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">INSERT INTO <span class="sb">`</span>datafordata<span class="sb">`</span>.<span class="sb">`</span>t_temp<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>id<span class="sb">`</span>, <span class="sb">`</span>comment<span class="sb">`</span>, <span class="sb">`</span>create_time<span class="sb">`</span>, <span class="sb">`</span>update_time<span class="sb">`</span><span class="o">)</span> VALUES <span class="o">(</span><span class="s1">&#39;4&#39;</span>, <span class="s1">&#39;helloworld&#39;</span>, <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;1&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">INSERT INTO <span class="sb">`</span>datafordata<span class="sb">`</span>.<span class="sb">`</span>t_temp<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>id<span class="sb">`</span>, <span class="sb">`</span>comment<span class="sb">`</span>, <span class="sb">`</span>create_time<span class="sb">`</span>, <span class="sb">`</span>update_time<span class="sb">`</span><span class="o">)</span> VALUES <span class="o">(</span><span class="s1">&#39;5&#39;</span>, <span class="s1">&#39;helloworld&#39;</span>, <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;1&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">INSERT INTO <span class="sb">`</span>datafordata<span class="sb">`</span>.<span class="sb">`</span>t_temp<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>id<span class="sb">`</span>, <span class="sb">`</span>comment<span class="sb">`</span>, <span class="sb">`</span>create_time<span class="sb">`</span>, <span class="sb">`</span>update_time<span class="sb">`</span><span class="o">)</span> VALUES <span class="o">(</span><span class="s1">&#39;6&#39;</span>, <span class="s1">&#39;helloworld&#39;</span>, <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;1&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">INSERT INTO <span class="sb">`</span>datafordata<span class="sb">`</span>.<span class="sb">`</span>t_temp<span class="sb">`</span> <span class="o">(</span><span class="sb">`</span>id<span class="sb">`</span>, <span class="sb">`</span>comment<span class="sb">`</span>, <span class="sb">`</span>create_time<span class="sb">`</span>, <span class="sb">`</span>update_time<span class="sb">`</span><span class="o">)</span> VALUES <span class="o">(</span><span class="s1">&#39;7&#39;</span>, <span class="s1">&#39;helloworld&#39;</span>, <span class="s1">&#39;1&#39;</span>, <span class="s1">&#39;1&#39;</span><span class="o">)</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="extra">extra</h2>
<p><a href="https://www.cnblogs.com/clsn/p/8138015.html#auto-id-40">https://www.cnblogs.com/clsn/p/8138015.html#auto-id-40</a><br>
<a href="https://segmentfault.com/a/1190000022440263">https://segmentfault.com/a/1190000022440263</a><br>
<a href="https://www.cnblogs.com/clsn/p/8150036.html#auto-id-0">https://www.cnblogs.com/clsn/p/8150036.html#auto-id-0</a></p>
<h2 id="基于mysql的主从复制案例未测试">基于MYSQL的主从复制案例，未测试</h2>
<blockquote>
<p>master</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run -p 3307:3306 --name mysql-master <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-v /mydata/mysql-master/log:/var/log/mysql <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-v /mydata/mysql-master/data:/var/lib/mysql <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-v /mydata/mysql-master/conf:/etc/mysql <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>root  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-d mysql:5.7
</span></span></code></pre></td></tr></table>
</div>
</div><p>在mysql的配置文件夹<code>/mydata/mysql-master/conf</code>中创建一个配置文件<code>my.cnf</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">touch my.cnf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>mysqld<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 设置server_id，同一局域网中需要唯一</span>
</span></span><span class="line"><span class="cl"><span class="nv">server_id</span><span class="o">=</span><span class="m">101</span> 
</span></span><span class="line"><span class="cl"><span class="c1">## 指定不需要同步的数据库名称</span>
</span></span><span class="line"><span class="cl">binlog-ignore-db<span class="o">=</span>mysql  
</span></span><span class="line"><span class="cl"><span class="c1">## 开启二进制日志功能</span>
</span></span><span class="line"><span class="cl">log-bin<span class="o">=</span>mall-mysql-bin  
</span></span><span class="line"><span class="cl"><span class="c1">## 设置二进制日志使用内存大小（事务）</span>
</span></span><span class="line"><span class="cl"><span class="nv">binlog_cache_size</span><span class="o">=</span>1M  
</span></span><span class="line"><span class="cl"><span class="c1">## 设置使用的二进制日志格式（mixed,statement,row）</span>
</span></span><span class="line"><span class="cl"><span class="nv">binlog_format</span><span class="o">=</span>mixed  
</span></span><span class="line"><span class="cl"><span class="c1">## 二进制日志过期清理时间。默认值为0，表示不自动清理。</span>
</span></span><span class="line"><span class="cl"><span class="nv">expire_logs_days</span><span class="o">=</span><span class="m">7</span>  
</span></span><span class="line"><span class="cl"><span class="c1">## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致</span>
</span></span><span class="line"><span class="cl"><span class="nv">slave_skip_errors</span><span class="o">=</span><span class="m">1062</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 重启实例</span>
</span></span><span class="line"><span class="cl">docker restart mysql-master
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -it mysql-master /bin/bash
</span></span><span class="line"><span class="cl">mysql -uroot -proot
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 创建同步的用户</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 1. 测试服务器之间互通 ping</span>
</span></span><span class="line"><span class="cl">CREATE USER <span class="s1">&#39;slave&#39;</span>@<span class="s1">&#39;%&#39;</span> IDENTIFIED BY <span class="s1">&#39;123456&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO <span class="s1">&#39;slave&#39;</span>@<span class="s1">&#39;%&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>slave</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker run -p 3308:3306 --name mysql-slave <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-v /mydata/mysql-slave/log:/var/log/mysql <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-v /mydata/mysql-slave/data:/var/lib/mysql <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-v /mydata/mysql-slave/conf:/etc/mysql <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-e <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>root  <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-d mysql:5.7
</span></span></code></pre></td></tr></table>
</div>
</div><p>在mysql的配置文件夹<code>/mydata/mysql-master/conf</code>中创建一个配置文件<code>my.cnf</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">touch my.cnf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>mysqld<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 设置server_id，同一局域网中需要唯一</span>
</span></span><span class="line"><span class="cl"><span class="nv">server_id</span><span class="o">=</span><span class="m">102</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 指定不需要同步的数据库名称</span>
</span></span><span class="line"><span class="cl">binlog-ignore-db<span class="o">=</span>mysql  
</span></span><span class="line"><span class="cl"><span class="c1">## 开启二进制日志功能，以备Slave作为其它数据库实例的Master时使用</span>
</span></span><span class="line"><span class="cl">log-bin<span class="o">=</span>mall-mysql-slave1-bin  
</span></span><span class="line"><span class="cl"><span class="c1">## 设置二进制日志使用内存大小（事务）</span>
</span></span><span class="line"><span class="cl"><span class="nv">binlog_cache_size</span><span class="o">=</span>1M  
</span></span><span class="line"><span class="cl"><span class="c1">## 设置使用的二进制日志格式（mixed,statement,row）</span>
</span></span><span class="line"><span class="cl"><span class="nv">binlog_format</span><span class="o">=</span>mixed  
</span></span><span class="line"><span class="cl"><span class="c1">## 二进制日志过期清理时间。默认值为0，表示不自动清理。</span>
</span></span><span class="line"><span class="cl"><span class="nv">expire_logs_days</span><span class="o">=</span><span class="m">7</span>  
</span></span><span class="line"><span class="cl"><span class="c1">## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致</span>
</span></span><span class="line"><span class="cl"><span class="nv">slave_skip_errors</span><span class="o">=</span><span class="m">1062</span>  
</span></span><span class="line"><span class="cl"><span class="c1">## relay_log配置中继日志</span>
</span></span><span class="line"><span class="cl"><span class="nv">relay_log</span><span class="o">=</span>mall-mysql-relay-bin  
</span></span><span class="line"><span class="cl"><span class="c1">## log_slave_updates表示slave将复制事件写进自己的二进制日志</span>
</span></span><span class="line"><span class="cl"><span class="nv">log_slave_updates</span><span class="o">=</span><span class="m">1</span>  
</span></span><span class="line"><span class="cl"><span class="c1">## slave设置为只读（具有super权限的用户除外）</span>
</span></span><span class="line"><span class="cl"><span class="nv">read_only</span><span class="o">=</span><span class="m">1</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">docker restart mysql-slave
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>主从库连接</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">show master status<span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># &gt;</span>
</span></span><span class="line"><span class="cl">+------------------+----------+--------------+------------------+-------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> File             <span class="p">|</span> Position <span class="p">|</span> Binlog_Do_DB <span class="p">|</span> Binlog_Ignore_DB <span class="p">|</span> Executed_Gtid_Set <span class="p">|</span>
</span></span><span class="line"><span class="cl">+------------------+----------+--------------+------------------+-------------------+
</span></span><span class="line"><span class="cl"><span class="p">|</span> mysql-bin.000004 <span class="p">|</span>      <span class="m">154</span> <span class="p">|</span>              <span class="p">|</span>                  <span class="p">|</span>                   <span class="p">|</span>
</span></span><span class="line"><span class="cl">+------------------+----------+--------------+------------------+-------------------+
</span></span><span class="line"><span class="cl"><span class="c1"># &gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 其中file是我们需要同步的文件 position是我们需要同步的游标地址</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">docker <span class="nb">exec</span> -it mysql-slave /bin/bash
</span></span><span class="line"><span class="cl">mysql -uroot -proot
</span></span><span class="line"><span class="cl">change master to <span class="nv">master_host</span><span class="o">=</span><span class="s1">&#39;192.168.6.132&#39;</span>, <span class="nv">master_user</span><span class="o">=</span><span class="s1">&#39;slave&#39;</span>, <span class="nv">master_password</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span>, <span class="nv">master_port</span><span class="o">=</span>3307, <span class="nv">master_log_file</span><span class="o">=</span><span class="s1">&#39;mall-mysql-bin.000004&#39;</span>, <span class="nv">master_log_pos</span><span class="o">=</span>154, <span class="nv">master_connect_retry</span><span class="o">=</span>30<span class="p">;</span>  
</span></span></code></pre></td></tr></table>
</div>
</div><p>参数说明</p>
<ul>
<li>master_host：主数据库的IP地址；</li>
<li>master_port：主数据库的运行端口；</li>
<li>master_user：在主数据库创建的用于同步数据的用户账号；</li>
<li>master_password：在主数据库创建的用于同步数据的用户密码；</li>
<li>master_log_file：指定从数据库要复制数据的日志文件，通过查看主数据的状态，获取File参数</li>
<li>master_log_pos：指定从数据库从哪个位置开始复制数据，通过查看主数据的状态，获取Position参数；</li>
<li>master_connect_retry：连接失败重试的时间间隔，单位为秒。</li>
</ul>
<p>在从机上查看同步状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">start slave <span class="c1"># 开启同步</span>
</span></span><span class="line"><span class="cl">show slave status <span class="se">\G</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">               Slave_IO_State: Waiting <span class="k">for</span> master to send event
</span></span><span class="line"><span class="cl">                  Master_Host: 10.0.6.43
</span></span><span class="line"><span class="cl">                  Master_User: asd
</span></span><span class="line"><span class="cl">                  Master_Port: <span class="m">3306</span>
</span></span><span class="line"><span class="cl">                Connect_Retry: <span class="m">60</span>
</span></span><span class="line"><span class="cl">              Master_Log_File: mysql-bin.000004
</span></span><span class="line"><span class="cl">          Read_Master_Log_Pos: <span class="m">154</span>
</span></span><span class="line"><span class="cl">               Relay_Log_File: 10-0-6-53-slave-relay-bin.000005
</span></span><span class="line"><span class="cl">                Relay_Log_Pos: <span class="m">367</span>
</span></span><span class="line"><span class="cl">        Relay_Master_Log_File: mysql-bin.000004
</span></span><span class="line"><span class="cl">             Slave_IO_Running: Yes
</span></span><span class="line"><span class="cl">            Slave_SQL_Running: Yes
</span></span></code></pre></td></tr></table>
</div>
</div><p>主要观察 <code>Slave_IO_Running</code> 以及 <code>Slave_SQL_Running</code> 这两个值，均为yes才表示在同步<br>
此时在主机上创建一个数据库，会在从机上创建同样的数据库</p>
<h2 id="脚注">脚注</h2>
<p><a href="https://www.cnblogs.com/rickiyang/p/13841811.html">带你了解 MySQL Binlog 不为人知的秘密 - rickiyang - 博客园 (cnblogs.com)</a></p>
<p><a href="https://www.jianshu.com/p/d4f6bf62825e">MySQL数据同步基础 - 简书 (jianshu.com)</a></p>
<p><a href="https://juejin.cn/post/7093415809246035981">MySQL备份与恢复 - 掘金 (juejin.cn)</a></p>
<p><a href="https://www.cnblogs.com/rickiyang/category/1825438.html">MYSQL 系列 - 随笔分类 - rickiyang - 博客园 (cnblogs.com)</a></p>
<p><a href="https://www.cnblogs.com/rickiyang/p/13559507.html">MySQL 索引结构 - rickiyang - 博客园 (cnblogs.com)</a></p>
<p><a href="https://www.cnblogs.com/rickiyang/p/13652664.html">一文说清 InnoDB 的事务机制 - rickiyang - 博客园 (cnblogs.com)</a></p>
<p>使用GTID实现主从复制 <a href="https://juejin.cn/post/6854573214719279117">MySQL主从复制集群—gtid实现详解 - 掘金 (juejin.cn)</a></p>
<p><a href="https://www.cnblogs.com/rickiyang/p/13856388.html">MySQL 主从复制原理不再难 - rickiyang - 博客园 (cnblogs.com)</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1662191">手把手教你搭建 MySQL 主从复制经典架构（一主一从、主主、一主多从、多主一从） - 腾讯云开发者社区-腾讯云 (tencent.com)</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">olOwOlo</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2022-08-01
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      
      <nav class="post-nav">
        
        
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
      <a href="http://localhost:1313" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="http://localhost:1313" class="iconfont icon-twitter" title="twitter"></a>
      <a href="http://localhost:1313" class="iconfont icon-facebook" title="facebook"></a>
      <a href="http://localhost:1313" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="http://localhost:1313" class="iconfont icon-google" title="google"></a>
      <a href="http://localhost:1313" class="iconfont icon-github" title="github"></a>
      <a href="http://localhost:1313" class="iconfont icon-weibo" title="weibo"></a>
      <a href="http://localhost:1313" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="http://localhost:1313" class="iconfont icon-douban" title="douban"></a>
      <a href="http://localhost:1313" class="iconfont icon-pocket" title="pocket"></a>
      <a href="http://localhost:1313" class="iconfont icon-tumblr" title="tumblr"></a>
      <a href="http://localhost:1313" class="iconfont icon-instagram" title="instagram"></a>
      <a href="http://localhost:1313" class="iconfont icon-gitlab" title="gitlab"></a>
      <a href="http://localhost:1313" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://hzjsea.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>olOwOlo</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.191509a5c8442abdb6eb5020a332fd59bdd83a7e78a2d2241108df9113504292.js"></script>








</body>
</html>
