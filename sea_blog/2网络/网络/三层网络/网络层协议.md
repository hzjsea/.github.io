## 网络基础知识总结

从OSI 7层模型到 TCP/IP 5层模式。
这里概述一下TCP/IP的5层模型, 主机之间的交流都是自上而下到自下而上。5层从下到上分别是 物理层,数据链路层,网络层,传输层,应用层



## 物理层
功能: 主要是基于电器特性发送高低电压(电信号)，高电压对应数字1，低电压对应数字 $\color{#FF3030}{电信号}$

## 数据链路层
1. 以太网协议
2. mac地址 mac地址的内容只和厂商
3. 广播
4. arp协议

功能：定义了电信号的分组方式


#### 以太网协议
对发送出来的电信号进行分组，为了保持统一性，出现 <font color="red">以太网协议</font>
以太网协议规定：
- 一组电信号构成一个数据包，叫做 $\color{blue}{帧}$
- 每一组数据帧的组成 ：报头 head  数据 data 两部分

head 包含（固定18个字节）
发送者/源地址  6个字节
接受者/目标地址 6个字节
数据类型     6个字节 

data包含  （46～1500字节）

数据包包含
head(18) + data(46~1500) = (64~1518)字节，超过限制则分片发送


#### mac地址
mac地址在网卡产生的时候，工厂会为他烧制一个世界上唯一的mac地址，但其实不一定是唯一的，只是出现重复的几率很小，或者说即使出现重也有解决方法。（前6位是厂商编号，后6位是流水线编号）
```bash
alpaca@alpacadeMacBook-Pro  ~  ifconfig p2p0
p2p0: flags=8843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST> mtu 2304
        ether 06:83:e7:83:71:89  # <------ mac地址
        media: autoselect
        status: inactive
```
上面讲到在数据链路层中，以太网协议会讲物理层发出的电信号 0或1 按组分成帧， 每个帧中包含head 和data ，head中包含了源地址和目的地址，这两个地址指的就是mac地址，mac地址的唯一性保证了设备之间的联系也同样具有唯一性，因此在同一网络中，主机之间可以使用mac地址进行通信


#### 广播
有了mac地址，同一网络内的两台主机之间就可以通信了，因为他们之间各自有了不同的身份（mac地址标识）。
那么如何通过mac地址建立通信呢，我们可以使用$\color{red}{arp协议}$


https://blog.csdn.net/ever_peng/article/details/80008638
https://www.jianshu.com/p/e3a0f972ca4d


## 网络层
1. ip协议
2. 子网掩码
3. IP数据包
4. ARP协议和RARP协议

功能：引入一套新的地址用来区分不同的广播域／子网，这套地址即网络地址

在之前除了arp，我们所接触的都是二层网络，即并有没有介入任何的网络地址，这样的区域我们称之为广播域(局域网)，但为了让不同局域网之间的所有主机能够通信,我们要为每台主机都配置网络地址，和mac地址一样的是，为了能够保持唯一性,网络地址也必须具有唯一性

网络层由来：有了ethernet、mac地址、广播的发送方式，世界上的计算机就可以彼此通信了，问题是世界范围的互联网是由一个个彼此隔离的小的局域网组成的，那么如果所有的通信都采用以太网的广播方式，那么一台机器发送的包全世界都会收到。这样来说，安全和效率上都是一个很大的问题，于是出现了局域网

现在我们可以知道整个世界的网络由一个个隔离开来的局域网组成，那么对于广播来说。隔离开来的每个局域网就是一个广播域， <font color="red">以太网(数据链路层)的广播包只能在一个广播域内发送</font>，跨广播域通信只能通过路由（三层）转发

于是网络层引入了一套新的地址用来区分不同的广播域，这套地址即网络地址

$\color{red}{规定网络地址的协议是ip协议}$

#### ip协议  ipv4
固定网络地址由32位2进制标示，范围 0.0.0.0～255.255.255.255 通常写为四段十进制 172.168.2.1

关于ip地址，我们可以分为合法ip地址(公网ip地址)和私有ip地址
合法的IP地址主要应用在internet上的主机访问，而私有ip地址应用于局域网之间的计算机互相通信(如果要组建一个封闭的局域网，则可以任意配置ABC三类IP地址，追要保证ip地址不重复就行了)  $\color{blue}{既然局域网之间已经有了mac地址来区分主机唯一性，那为什么还需要有私有的ip地址来维持通行呢？}$

IP：【网络部分】【主机部分】
IP地址主要分为网络部分和主机部分，网络号用于确定某一特定的网络，主机号用于确定该网络中某一特定的主机，同一个网络中绝对不存在主机好相同的两台计算机

$\color{green}{这里很容易弄混乱}$,上面已经讲了，ip的组层虽然在表示上是以四组十进制的形式体现的，但是在实际上是32位2进制进行标志的，那么 
1.0.0.0.0.0.0.0 0.0.0.0.0.0.0.0 0.0.0.0.0.0.0.0 0.0.0.0.0.0.0.1 他的ip地址就是128.0.0.1


#### 各类IP地址
各类ip的网络地址位数不同
- A类ip 的网络地址第一位必须为0 , 网络地址为8位 主机24位
    那么他的地址范围就从 00000001 0 ～ 011111111 1
    换算成四段2进制 就是 1.0.0.0 --> 127.255.255.255 (从0次方开始算)
    但是由于127被保留作为回路以及诊断功能，所以127不会出现在a类地址当中
    于是 a类ip段就是 1.0.0.0 --> 126.255.255.255

- B类ip 的网络地址前两位必须为10 ,网络地址位为16位 主机 16位
    地址范围就是  10000000 0 ～ 10111111 1
    于是a类ip段  128.0.0.0 ～ (128+32+16+8+4+2+1) 191.255.255.255

- C类ip 的网络地址前三位必须为110 , 网络地址为24位 主机地址位8位
    地址范围就是 11000000 0 ~ 11011111 1
    于是c类的ip段 192.0.0.0 ～ (255-32) 223.255.255.255 

- D类ip 的网络地址前四位必须位1110  用于组播

- E类ip 的网络地址前必须位11110 用于科研保留

特殊的IP地址
网络地址 主机位全0
广播地址 主机位全1
回环地址 127.0.0.1

#### 标准子网掩码
为了区分ip是否属于同一个局域网，我们将ip分为了网络位和主机位，同时也定义了网络位和主机位的划分规则，称之为子网掩码。掩码分为两种，一种是标准的子网掩码，用来区分ip中的abcde类，比如255.0.0.0 就是a类ip的标准子网掩码，另外一种是自定义的子网掩码，他在abcde类ip的定义上又对剩下的主机位进行了划分，主要是减少ip段的浪费，如192.168.20.1/30 本身c类ip的网络位是24位，掩码也是255.255.255.0 但是当前网络位是30位，则他的掩码就是255.255.255.(255-3)

#### 自定义子网掩码
在这之前我们所讲的子网掩码是标准的子网掩码，但在现实的使用当中，我们使用更多的是自定义的子网掩码，为了减少ip资源的浪费
$\color{yellow}{为什么要使用自定义的子网掩码?}$
```text
>> 新手一般都会遇到这样的疑问，空间子网掩码是什么，要它干什么：比如说一个C类的IP段220.13.22.0--220.13.22.255, 如果我们把它给一个计算机网络,那就是给了这个计算机网络255个IP,但是这个网络里是不一定有255个计算机的,有可以就10台,或20台, 这们的话，就会造成IP段的浪费，会剩下很多IP并没有计算机来得到。现在我们通过子网掩码的作用,就可以把附近的几个独立的计算机网络放个一起,来把这个255个的IP段分成一小段一小段（比如10-20，30-40，……）也就是一个个小的子网，分给它们,而不是它们一人一个255个IP段,这样就充分利用了IP的资源,因为IP现在很溃乏.IPv6正在试验中!!
```
既然引入了自定义的子网掩码,而且她也常使用于现实的生活中，因此在学习之前，应该要抛弃之前的标准子网掩码
首先我们需要来整理一下，为了判断ip是不是属于某同一个局域网，我们将ip划分成了两个部分，网络位和主机位，为了划分网络位和主机位，出现了子网掩码，在标准模式下，网络位和主机位数根据ip类别的不同，是有固定的数量的 从A--->C  子网掩码分别是 255.0.0.0 255.255.0.0 255.255.255.0 网络位分别位 8 16 24 主机位分别为 24 16 8 这里我们需要知道一个概念 $\color{子网掩码决定了主机位和网络位而不是主机位和网络位决定了子网掩码}$


#### 计算ip中的组成部分
1.网络位:子网掩码是多少，网络位就是多少
2.主机位:32-网络位
3.网络地址，广播地址
网上的方法是 首先得到ip地址和子网掩码，然后做与运算
**与运算，0&0=0 1&1=1 0&1=1&0=0**
举例: ip 192.168.10.215 子网掩码 255.255.255.0
11000000 10101000 00001010 11010111
11111111 11111111 11111111 00000000

= 11000000 10101000 00001010 00000000
= 192.168.10.0

但是我觉得不用这么麻烦。首先子网掩码是255.255.255.0可以知道网络是占了24位
则网络地址就是192.168.10.0 如果子网掩码是255.255.0.0 则网络地址是192.168.0.0
**其实就是全0作为网络地址，全1作为广播地址**
4.主机数
2的主机数次方-2
例子 192.168.20.1/30 2的2次方-2 =2个可用
广播地址 192.168.20.3 网络地址192.168.20.0

#### ip数据包
ip数据包也分为head和data部分，无须为ip包定义单独的栏位，直接放入以太网包的data部分

head：长度为20到60字节
data：最长为65,515字节。
而以太网数据包的”数据”部分，最长只有1500字节。因此，如果IP数据包超过了1500字节，它就需要分割成几个以太网数据包，分开发送了。

以太网头   ip 头  ip数据                                

#### arp协议
现在我们有了mac地址来区分数据链路层上成员的身份，有了ip地址来区分三层网络上的成员身份，这时候我们就需要来寻找对象达成通信的目的，这里分为跨层级通信和不跨层级通信

用户(经过链路层和网络层后，已经有了mac地址和ip地址，缺少对端的ip地址和mac地址)在浏览器端输入地址(192.168.20.1，对端IP地址)之后会在本地缓存(arp缓存表)中去寻找ip和mac之间的映射关系，如果有，直接把目标mac地址写入到帧里面发送。如果没有缓存，则发出广播，为了到达所有主机，所以该广播的目标mac地址是全F,询问他们 192.168.20.1的mac地址是多少？

被广播主机收到广播后会查看自己的路由表，如果存在192.168.20.1,则会发送一个ARP响应信息，将ip地址和mac地址告诉发送广播的主机，且响应信息是以单播的形式发送的，第一次的请求是以广播的形式发送的

arp广播也称为以太网广播、链路层广播。arp在发出请求的时候会带上ip地址，与所有之间进行交互，如果所带ip地址出现在该主机路由表中，则会记录当前主机的mac地址，用作下次访问

**arp高速缓存**
ARP高速缓存的作用实际上就是主机A会把主机B的IP地址和mac地址缓存到一张缓存表里面
在主机A发送广播，在局域网中寻找某个IP的对应主机的mac地址时候为了减少网络上的通信量，主机A在发送其ARP请求分组时就将自己的IP地址到硬件地址的映射写入ARP请求分组。当主机B收到A的ARP请求分组时，就将主机A的这一地址映射写入主机B自己的ARP高速缓存中，这对主机B以后向A发送数据报时就更方便了。

**跨级arp**
上面所讲的过程都是在同一个局域网内的arp过程，如果两台机器不在同一个局域网中，arp会找到一个位于本局域网的某个路由器的硬件地址，然后把分组发送到这个路由器，让这个路由器把分组转发给下一个网络

**arp缓存表**
正常情况下，arp缓存表的过期时间为2分钟,在交换机中，查看arp表的命令是dis arp
```text
[CTN-FJ-FOC-S01]display arp
  Type: S-Static   D-Dynamic   O-Openflow   R-Rule   M-Multiport  I-Invalid
IP address      MAC address    VLAN     Interface                Aging Type
117.27.142.22   0cda-4116-dac0 1        XGE1/0/44                10    D
117.27.142.9    001b-217f-21a4 1        XGE1/0/12                20    D
117.27.142.3    6c92-bf38-852c 1        BAGG1                    8     D
117.27.142.23   6c92-bf38-852c 1        BAGG1                    15    D
117.27.142.29   6c92-bf38-852c 1        BAGG1                    16    D
117.27.142.30   6c92-bf38-852c 1        BAGG1                    16    D
117.27.142.4    6c92-bf38-8770 1        BAGG2                    3     D
117.27.142.6    6c92-bf38-86fc 1        BAGG4                    4     D
117.27.142.7    6c92-bf38-85c8 1        BAGG5                    4     D
117.27.142.5    6c92-bf38-8640 1        BAGG3                    6     D
192.168.142.5   6c92-bf38-8640 1        BAGG3                    20    D
117.27.142.16   001b-2180-020d 1        XGE1/0/16                19    D
172.16.12.1     e468-a391-1372 10       BAGG110                  14    D
117.27.142.8    001b-218a-7840 1        XGE1/0/13                20    D
```
其中 有ip地址 mac地址 vlan interface 


**代理arp**
代理ARP（Proxy-arp）的原理就是当出现跨网段的ARP请求时，路由器将自己的MAC返回给发送ARP广播请求发送者，实现MAC地址代理（善意的欺骗），最终使得主机能够通信。 

https://img-blog.csdn.net/20180420225547561?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM1NzMzNzUx/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70


上图中R1和R3处于不同的局域网，R1和R3在相互通信时，R1先发送了一个ARP广播数据包，请求R3的mac地址，但是由于R1是12.1.1.0网段，而R3是13.1.1.0网段，R1和R3之间是跨网段访问的，也就是说R1的ARP请求会被R2拦截到，然后R2会封装自己的mac地址为目的地址发送一个ARP回应数据报给R1（善意的欺骗），然后R2就会代替R1去访问R3。

  整个过程R1以为自己访问的是R3，实际上真正去访问R3的是R2，R1却并不知道这个代理过程，这就是所谓的ARP代理，通常用于跨网段访问。

  注意：如果R2关闭了arp的代理功能，那么R1再访问R3的时候，R2并不会把自己的mac地址给R1，那么R1和R3之间就无法通信。默认情况下，思科的设备是开启了arp代理功能，也就是说，R2会作为中间代理实现R1和R3之间跨网段通信。

  代理ARP的使用场景为：1. 没有路由功能的主机，2. 有路由功能，目的地指向本地出口

**RARP协议**
(Reverse Address Resolution Protocol)逆地址解析协议，将局域网中某个主机的物理地址转换为IP地址，比如局域网中有一台主机只知道物理地址而不知道IP地址，那么可以通过RARP协议发出征求自身IP地址的广播请求，然后由RARP服务器负责回

之前的ARP协议是通过链路层的mac和网络层已知的ip地址，通过广播的形式在其他主机的路由表上寻找对应ip的mac地址。但是在无盘工作站中，无盘主机本身就不能知道自己的ip地址，但是他具有唯一的硬件地址，无盘系统的RARP实现过程是从网卡上读取唯一的硬件地址，通过RARP协议发出征求自身IP地址的广播请求，然后由RARP服务器负责回答。<font color='red'>RARP协议广泛应用于无盘工作站引导时获取IP地址。</font>

工作流程:
```txt
1.主机发送一个本地的RARP广播，在此广播包中，声明自己的mac地址并且请求任何可以收到此请求的RARP服务器分配一个IP地址
2.本地网段上的RARP服务器收到此请求后，检查其RARP列表，查找该MAC地址对应的IP地址。
3.如果存在，RARP服务器就给源主机发送一个响应数据包并将此IP地址提供给对方主机使用。
4.如果不存在，RARP服务器对此不做任何的响应。
5.源主机收到从RARP服务器的响应信息，就利用得到的IP地址进行通讯；如果一直没有收到RARP服务器的响应信息，表示初始化失败。
```


## 传输层

在之前我们已经了解到了5层模型中的物理层 数据链路层 网络层 。 接下来就是传输层。数据链路层通过mac寻找主机，网络层通过ip区分子网，传输层通过主机上的端口寻找应用程序

功能： 建立端口与端口之间的通信
其中0-65535 0-1023为系统占用端口

#### tcp协议
https://www.cnblogs.com/lifei01/p/10605568.html

## 应用层
只认识ip地址，
DNS域名解析服务器




## 浏览器输入URL发生了什么
1.用户向浏览器的地址栏中输入url地址(这个url地址包括ip地址或者域名地址),如果为ip地址直接跳转至下一步，如果是域名地址，则进行域名解析。
域名解析的流程，首先浏览器会在本地寻找该ip的信息，如果没有在去请求ip的信息
```text
1) 浏览器缓存,第一步浏览器回去自身的浏览器缓存中寻找DNS记录，浏览器本身会存储DNS记录一段时间
2） 系统缓存 – 如果在浏览器缓存里没有找到需要的记录，浏览器会做一个系统调用（windows里是gethostbyname）。这样便可获得系统缓存中的记录。
3)  路由器缓存，接着，前面的查询请求发向路由器，它一般会有自己的DNS缓存
4)  ISP缓存,接下来要check的就是ISP缓存DNS的服务器。在这一般都能找到相应的缓存记录。
5)  递归搜索 – 你的ISP的DNS服务器从跟域名服务器开始进行递归搜索，从.com顶级域名服务器到Facebook的域名服务器。一般DNS服务器的缓存中会有.com域名服务器中的域名，所以到顶级服务器的匹配过程不是那么必要了 ，递归查询流程
https://www.cnblogs.com/shy0322/p/9276883.html
```
2.浏览器和目标服务器建立tcp连接
主机浏览器通过DNS解析得到了目标服务器的IP地址后，与服务器建立TCP连接。
<font color='red'>TCP3次握手连接</font>：浏览器所在的客户机向服务器发出连接请求报文（SYN标志为1）；服务器接收报文后，同意建立连接，向客户机发出确认报文（SYN，ACK标志位均为1）；客户机接收到确认报文后，再次向服务器发出报文，确认已接收到确认报文；此处客户机与服务器之间的TCP连接建立完成，开始通信
3.浏览器通过http协议发送请求
4.个别服务会做永久重定向相应
5.浏览器跟踪重定向
6.服务器处理请求
7.服务器发出html响应
8.释放TCP连接
9.浏览器现实页面
10.浏览器执行js等内容，获取动态数据加入内容到静态html页面中




## 每层常见的物理设备
------ 传输层 -------- 四层交换机 四层路由器
------ 网络层 -------- 路由器 三层交换机
------ 数据链路层 ----- 网桥 、 以太网交换机 、 网卡
------ 物理层 -------- 中继器 、集线器 、双绞线



ospf负载均衡(三层扩量)   端口聚合 (二层聚合)







## url
网络基础
https://www.cnblogs.com/lifei01/p/10605568.html
在线ip计算
http://ip.chacuo.net/ipcalc
-----> ip地址与子网划分 https://blog.csdn.net/qq_22313585/article/details/79114654



## v4单播、广播、多播地址
