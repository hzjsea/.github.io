---
title: ansible模块合集
categories:
  - ansible
tags:
  - ansible
abbrlink: df208085
date: 2020-03-18 15:49:13
---



<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [ansible模块合集](#ansible模块合集)
  - [file模块](#file模块)
    - [参数](#参数)
  - [unarchive 解压缩](#unarchive-解压缩)
    - [参数](#参数-1)
  - [fetch模块 远程文件copy到本地](#fetch模块-远程文件copy到本地)
    - [实例](#实例)
  - [copy模块](#copy模块)
    - [参数](#参数-2)
    - [实例](#实例-1)
  - [synchronize模块 多级目录拷贝](#synchronize模块-多级目录拷贝)
    - [参数](#参数-3)
    - [实例](#实例-2)
  - [blockinfile模块](#blockinfile模块)
  - [lineinfile模块](#lineinfile模块)
  - [yum模块](#yum模块)
    - [参数](#参数-4)
    - [实例](#实例-3)
  - [git模块](#git模块)
    - [参数](#参数-5)
    - [实例](#实例-4)
  - [ansible-playbook参数](#ansible-playbook参数)
  - [playbook语法检查](#playbook语法检查)

<!-- /code_chunk_output -->


ansible模块
<!-- more -->
# ansible模块合集
https://www.zsythink.net/archives/2542
https://handerfly.github.io/ansible/2019/07/06/Ansible%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97/




## file模块
file模块可以帮助我们完成一些对文件的基本操作，比如，创建文件或目录、删除文件或目录、修改文件权限等

### 参数

```bash
- path参数 ：必须参数，用于指定要操作的文件或目录。
- state参数 ：
    - 创建文件夹，需要将state的值设置为directory，
    - 创建文件时，需要将state的值设置为touch，
    - 创建连接文件是，需将state设置为link，
    - 创建硬连接文件，需要将state设置为hard，
    - 当我们想要删除一个文件时，需要将state的值设置为absent
- src参数 ：当state设置为link或者hard时，表示我们想要创建一个软链或者硬链，所以，我们必须指明软链或硬链链接的哪个文件，通过src参数即可指定链接源。
- force参数  :  当state=link的时候，可配合此参数强制创建链接文件，当force=yes时，表示强制创建链接文件，不过强制创建链接文件分为两种情况，情况一：当你要创建的链接文件指向的源文件并不存在时，使用此参数，可以先强制创建出链接文件。情况二：当你要创建链接文件的目录中已经存在与链接文件同名的文件时，将force设置为yes，回将同名文件覆盖为链接文件，相当于删除同名文件，创建链接文件。情况三：当你要创建链接文件的目录中已经存在与链接文件同名的文件，并且链接文件指向的源文件也不存在，这时会强制替换同名文件为链接文件。
- owner参数 ：用于指定被操作文件的属主，属主对应的用户必须在远程主机中存在，否则会报错。
- group参数 ：用于指定被操作文件的属组，属组对应的组必须在远程主机中存在，否则会报错。
mode参数：用于指定被操作文件的权限，比如，如果想要将文件权限设置为"rw-r-x---"，则可以使用
- mode=650进行设置，或者使用mode=0650，效果也是相同的，如果你想要设置特殊权限，比如为二进制文件设置suid，则可以使用mode=4700，很方便吧。
- recurse参数：当要操作的文件为目录，将recurse设置为yes，可以递归的修改目录中文件的属性
```



## unarchive 解压缩

### 参数
```bash
- src 需要解压文件夹路径
- copy yes|no  如果是yes 会拷贝文件到目标机器，否则会在目标机器上面找需要解压的文件
- creates  如果指定的文件存在则不执行该任务。可用于实现幂等性
- dest 解压文件夹后存放路径 需要绝对路径
- group 
- mode
- owner
- exclude 解包时忽略部分目录和文件

```

实例
```bash
- unarchive: src=foo.tgz dest=/var/lib/foo
- unarchive: src=/tmp/foo.zip dest=/usr/local/bin copy=no
- unarchive: src=/tmp/test.tar.gz dest=/opt/tmp/ creates=/opt/tmp/ copy=no
```



## fetch模块 远程文件copy到本地

### 实例
```bash
- fetch: src=/tmp/somefile dest=/tmp/fetched
- fetch: src=/tmp/somefile dest=/tmp/prefix-{{ ansible_hostname }} flat=yes
- fetch: src=/tmp/uniquefile dest=/tmp/special/ flat=yes
- fetch: src=/tmp/uniquefile dest=special/prefix-{{ ansible_hostname }} flat=yes
```

## copy模块

### 参数
- src参数    :用于指定需要copy的文件或目录
- dest参数  :用于指定文件将被拷贝到远程主机的哪个目录中，dest为必须参数
- content参数  :当不使用src指定拷贝的文件时，可以使用content直接指定文件内容，src与content两个参数必有其一，否则会报错。
- force参数  :  当远程主机的目标路径中已经存在同名文件，并且与ansible主机中的文件内容不同时，是否强制覆盖，可选值有yes和no，默认值为yes，表示覆盖，如果设置为no，则不会执行覆盖拷贝操作，远程主机中的文件保持不变。
- backup参数 :  当远程主机的目标路径中已经存在同名文件，并且与ansible主机中的文件内容不同时，是否对远程主机的文件进行备份，可选值有yes和no，当设置为yes时，会先备份远程主机中的文件，然后再将ansible主机中的文件拷贝到远程主机。
- owner参数 : 指定文件拷贝到远程主机后的属主，但是远程主机上必须有对应的用户，否则会报错。
- group参数 : 指定文件拷贝到远程主机后的属组，但是远程主机上必须有对应的组，否则会报错。
- mode参数 : 指定文件拷贝到远程主机后的权限，如果你想将权限设置为"rw-r--r--"，则可以使用mode=0644表示，如果你想要在user对应的权限位上添加执行权限，则可以使用mode=u+x表示。

### 实例
```bash
# 拷贝文件
ansible nameserver -m copy -a "src=/testdir/copytest dest=/opt/"
# 在文件中添加内容
ansible test70 -m copy -a 'content="aaa\nbbb\n" dest=/opt/test'
# 拷贝过程中是否覆盖
ansible test70 -m copy -a "src=/testdir/copytest dest=/opt/ force=no"
# 是否备份
ansible test70 -m copy -a "src=/testdir/copytest dest=/opt/ backup=no"
# 拷贝之后修改权限
ansible test70 -m copy -a "src=/testdir/copytest dest=/opt/ owner=zsy"
# 修改组
ansible test70 -m copy -a "src=/testdir/copytest dest=/opt/ group=zsy"
# 指定权限
ansible test70 -m copy -a "src=/testdir/copytest dest=/opt/ mode=0640"
```

## synchronize模块 多级目录拷贝
synchronize模块与copy模块一样，都是将本机文件拷贝到对端机器上面，但是在拷贝多层级深层级目录的时候，synchronize模块的速度更快
### 参数
- src 传送的本机文件地址
- archive: 归档，相当于同时开启recursive(递归)、links、perms、times、owner、group、-D选项都为yes ，默认该项为开启
- checksum: 跳过检测sum值，默认关闭
- compress:是否开启压缩
- copy_links：复制链接文件，默认为no ，注意后面还有一个links参数
- delete: 删除不存在的文件，默认no
- dest：目录路径
- dest_port：默认目录主机上的端口 ，默认是22，走的ssh协议
- dirs：传速目录不进行递归，默认为no，即进行目录递归
- rsync_opts：使用rsync参数部分
- rsync_path: 服务的路径，指定rsync在远程服务器上执行
- rsync_remote_user: 设置远程用户名
- --exclude=*.log: 忽略同步以.log结尾的文件`这个是rsync的参数，必须开启rsync 比如rsync_opts=--exclude=*.txt` 
`开启rsync_opts必须要两机之间使用秘药登陆`
- set_remote_user：主要用于/etc/ansible/hosts中定义或默认使用的用户与rsync使用的用户不同的情况
- mode: push或pull 模块，push模的话，一般用于从本机向远程主机上传文件，pull 模式用于从远程主机上取文件，默认为push


### 实例
```bash
# 拉取文件
ansible -i /root/ansible_copy/hosts backup -m synchronize -a 'src=/tmp/svr_01/backup/ dest=/tmp/svr_02/backup/'
ansible -i /root/ansible_copy/hosts backup -m synchronize -a 'mode=push src=/tmp/svr_01/backup/ dest=/tmp/svr_02/backup/'
# 收取文件
ansible -i /root/ansible_copy/hosts backup -m synchronize -a 'mode=pull src=/tmp/svr_01/backup/ dest=/tmp/svr_02/backup/'
# 上传文件，且过滤.txt
ansible -i /root/ansible_copy/hosts backup -m synchronize -a 'mode=push src=/tmp/svr_01/backup/ dest=/tmp/svr_02/backup/ rsync_opts=--exclude=*.txt' 
```


## blockinfile模块

## lineinfile模块   

## yum模块

### 参数
- name参数：必须参数，用于指定需要管理的软件包，比如nginx
- state参数：用于指定软件包的状态 ，默认值为present，表示确保软件包已经安装，除了present，其他可用值有installed、latest、absent、removed，其中installed与present等效，latest表示安装yum中最新的版本，absent和removed等效，表示删除对应的软件包。
- disable_gpg_check参数：用于禁用对rpm包的公钥gpg验证，默认值为no，表示不禁用验证，设置为yes表示禁用验证，即不验证包，直接安装，在对应的yum源没有开启gpg验证的情况下，需要将此参数的值设置为yes，否则会报错而无法进行安装。
- enablerepo参数：用于指定安装软件包时临时启用的yum源，假如你想要从A源中安装软件，但是你不确定A源是否启用了，你可以在安装软件包时将此参数的值设置为yes，即使A源的设置是未启用，也可以在安装软件包时临时启用A源。
- disablerepo参数：用于指定安装软件包时临时禁用的yum源，某些场景下需要此参数，比如，当多个yum源中同时存在要安装的软件包时，你可以使用此参数临时禁用某个源，这样设置后，在安装软件包时则不会从对应的源中选择安装包。
- enablerepo参数和disablerepo参数可以同时使用
### 实例
```bash
ansible test70 -m yum -a 'name=nginx disable_gpg_check=yes'
ansible test70 -m yum -a 'name=nginx state=present disable_gpg_check=yes'
ansible test70 -m yum -a 'name=nginx state=installed disable_gpg_check=yes'
```


## git模块
就是我们平常用的git，从远程仓库拉项目
### 参数
```bash
archive 使用扩展名指定存档文件路径。 如果指定，则创建包含源树树结构的指定格式的存档文件。 允许的存档格式[“zip”，“tar.gz”，“tar”，“tgz”]
这将从本地目录克隆并执行git archive

bare 如果yes，则将创建存储库作为裸存储库，否则它将是具有工作空间的标准存储库。

depth clone的深度，最小值为1

repo git的仓库路径
version 项目版本号
dest 克隆项目存放地址
remote 远程仓库名

```

### 实例
```yml
# git项目到本地
---
  - name: clone project or file
    local_action: git repo={{ conf_repo }} dest={{ conf_path }} version={{ conf_hash | default('master') }}
    run_once: true

---
  - name: clone project with version
    local_action: git repo={{ pro_repo }} dest={{ dest_repo }} version={{ conf_hash }}
  
---
  - name: just ensuring the project checkout exists
    local_action: git repo={{ pro_repo }} dest={{ dest_repo }} update=no

---
  - name: Example Create git project and  archive from repo
    local_action: git repo={{ pro_repo }} dest={{ dest_repo }}  archive={{ dest_repo}}.zip

```



存在的问题git的dest文件需要是一个空文件夹





## ansible-playbook参数
- local_action 从本地运行当前模块
```bash
local_action: command ping -c 1 {{ inventory_hostname }}
# 从本地ping 主机列表中的所有主机
local_action: git repo={{ conf_repo }} dest={{ conf_path }} version{{ conf_hash | default('master') }}
# 克隆项目到本地,如果去掉local_action 则会克隆项目到远程主机
```
- run_once 只执行一次


## playbook语法检查
ansible-playbook --syntax-check /testdir/ansible/test.yml