---
title: 开发ansible模块
categories:
  - ansible
tags:
  - ansible
abbrlink: 179b600b
date: 2020-03-17 11:17:28
---

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [开发ansible模块](#开发ansible模块)
  - [规定环境](#规定环境)
  - [ansible 模块的格式要求](#ansible-模块的格式要求)

<!-- /code_chunk_output -->
<!-- more -->

# 开发ansible模块

<font color='red'>写在最前面</font>

>Ansible本身就是由python写成，所有其对python形式的API的支持应该不错。
>　　其API分不同的版本，这个版本也就是ansible本身的版本，可以通过ansible --version命令查看或者在python中import ansible然后查看anisble.\_\_version\_\_。
>　　在2.0及以后的版本，难度突然陡增，与此同时更多的更加底层的东西被开放给一般开发，虽然复杂了，但是也更加灵活了。


## 规定环境
```bash
[root@hzj tmp]# ansible --version
ansible 2.4.0.0
  config file = /etc/ansible/ansible.cfg
  configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/local/lib/python3.6/site-packages/ansible
  executable location = /usr/local/bin/ansible
  python version = 3.6.8 (default, Aug  7 2019, 17:28:10) [GCC 4.8.5 20150623 (Red Hat 4.8.5-39)]
```
安装环境
```bash
# 安装依赖文件
yum install build-essential libssl-dev libffi-dev python-dev
# 安装存储库
git clone https://github.com/ansible/ansible.git
# 准备虚拟环境
cd ansible
virtualenv env
source ./env/bin/active
pip install -r requirements.txt
# 为每个新的dev shell进程运行环境设置脚本： 
. hacking/env-setup
```

## ansible 模块的格式要求
https://docs.ansible.com/ansible/2.7/dev_guide/developing_modules_documenting.html#developing-modules-documenting

```py
# 版权许可
#!/usr/bin/python

# Copyright: (c) 2018, Terry Jones <terry.jones@example.org>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

# 模块信息
ANSIBLE_METADATA = {'metadata_version': '1.1',
                    'status': ['preview'],
                    'supported_by': 'community'}

# metadata_version是ANSIBLE_METADATA模式的版本，而不是模块的版本。
# 升级模块status或supported_by状态只能由Ansible核心团队的成员来完成。


# 文档描述
DOCUMENTATION = '''
---
module: backup
short_description: get backup_version from /usr/local/{{ project }}/.version
version_added: "2.4"
author: lin.jiang
'''

# 使用举例
EXAMPLES = '''
- name: get last version from .version
  backup: role={{ project }} version={{ app_version }}-{{ conf_hash }}
'''

# 运行流程
from ansible.module_utils.basic import AnsibleModule

def run_module():
    # 参数列表
    module_args = dict(
        name=dict(type='str', required=True),
        new=dict(type='bool', required=False, default=False)
    )

    # 参数检测 
    module = AnsibleModule(
        argument_spec=module_args,
        supports_check_mode=True
    )
    
    # 返回结果
    result = dict(
        changed=False,
        original_message='',
        message=''
    )

    # 如果参数检测通过，则返回结果
    if module.check_mode:
        return result

    # 对输入的参数进行操作
    if module.params['name'] == 'fail me':
        module.fail_json(msg='You requested this to fail', **result)

    # in the event of a successful module execution, you will want to
    # simple AnsibleModule.exit_json(), passing the key/value results
    module.exit_json(**result)

# 使用
def main():
    run_module()

if __name__ == '__main__':
    main()
```