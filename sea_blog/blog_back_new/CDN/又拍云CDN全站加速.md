---
title: 又拍云CDN全站加速的问题
categories:
  - 技术补充
tags:
  - CDN
abbrlink: 8ab41a0f
date: 2020-05-05 13:30:07
---


<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [CDN加速](#cdn加速)
  - [CDN是否支持度i](#cdn是否支持度i)
  - [又拍云CDN全站加速](#又拍云cdn全站加速)
  - [使用](#使用)
  - [错误](#错误)

<!-- /code_chunk_output -->

<!-- more -->


# CDN加速
CDN加速的功能主要在于
1. 对静态资源做加速，在首次请求之后，CDN会把一些对于静态资源的请求放在路过的节点上面做缓存处理，用户下一次请求的时候，CDN会先判断节点上是否存在静态资源，如果存在则直接返回该请求结果，如果不存在，则跳到下一个节点重复以上步骤，到最后一个边缘节点如果没有资源的话，就会回源访问源站获取请求结果  另外CDN会对回源之前的操作有一个评估，一般中标率要达到90%以上，也就是用户可以在途中获取到缓存内容的几率
2. CDN加速可以对域名做整理，并且对源站IP做隐藏，防止IP暴露被人恶意攻击， 两层CNAME+NGINX反向代理  CDN流程  `阿里云服务器源站IP 192.168.0.1 --> CND做源站加速 (192.168.20.1:80 -> aicdn.qiniu.com) ----> 阿里云对CDN暴露出来的域名做CNAME,并且使用子域名 (aicdn.qiniu.com -> lookme.blog.com)`
3. 防ddos 优化链路连接性 高防IP等等 这部分就是花钱买买买，CDN内部会实现专线提供服务‘
4. 全站加速，这个是可以算作为API提供的CDN加速，他只要实现的功能是动静态内容分离，也就是静态内容做缓存，动态内容做链路加速等等操作

## CDN是否支持度i
动态内容是指不同的请求访问中获得不同数据的内容，例如：网站中的.asp、.jsp、.php、.perl、.cgi文件、API接口和动态交互请求（post、put和patch等请求）。
对于动态请求的内容，CDN无法缓存实时变化的内容，需要用户每次回源访问您的源站服务器。若您配置的域名业务类型为网站加速、文件下载加速或点播加速，不支持动态内容的加速。
若您的网站含有较多动态内容，可以配置全站加速。全站加速融合了动态和静态加速，用户请求资源时，静态内容从边缘节点就近获取，动态内容通过动态加速技术智能选择较优路由回源获取。目前华为云CDN支持通过提交工单的方式配置全站加速。

## 又拍云CDN全站加速

https://v3u.cn/a_id_128

之前给自己的API接口做了CND的全站加速，因为APi接口是动态的，所以只能选择全站加速
其中CND加速就是采用更多的缓存服务器（CDN边缘节点），布放在用户访问相对集中的地区或网络中。当用户访问网站时，利用全局负载技术，将用户的访问指向距离最近的缓存服务器上，由缓存服务器响应用户请求
![CDN架构动态图](https://v3u.cn/v3u/Public/js/editor/attached/image/20190530/20190530065911_52568.gif)

也就是对你的请求做了中转
假设你的服务器是部署在阿里云上，这台服务器现在在云南某机房1柜，现在有一个西藏的用户对其进行请求，在不使用CDN加速的情况下， 西藏用户的请求会直接走运营商到达阿里云上，这是直连的,但对于阿里来说，你只是一个普通的用户，走的线路也应是普通的线路，在此，你的请求老老实实的走了这一段路

现在我们在中间插入CND加速，当我们在西藏发送一个请求后，请求会先到达CDN的西藏边缘节点，再由边缘节点发送请求，这时候你走的是CND内部的架构加速通道，他会选择一部分最优节点，到达云南某机房1柜，因此在速度上有了保证，在有缓存的条件下，请求甚至不用达到云南机房，而会在边缘节点的上找到缓存，从而达到加速

## 使用
pass

## 错误

这里有一个需要提醒的错误，我也是挖坑了好久，当我部署完APi之后，发现APi的请求不能访问，但是换成IP就可以
<font color='red'>这有可能是阿里云的白名单问题</font>
在白名单中我们添加CDN运营商为又拍云允许就可以了
![2020-05-05-13-41-31](http://noback.upyun.com/2020-05-05-13-41-31.png)
原因是这里我们做了阿里域名到又拍域名的CNAME转发
<font color='red'>这里再提一句，有时候我们dig的时候会发现没有CNAME，这是因为这个请求其实是从边缘节点上直接拿的缓存</font>


也有可能是程序里面没有写跨域请求

切换成域名之后还是不能使用，并且每次请求都会报422的错误，这是因为拍云的CDN加速中，有一个参数跟随的设置，默认是不允许跟随参数的，设置参数跟随，这里比较坑的一点就是又拍云默认不跟随网址参数，也就是通过问好传参他根本就不识别，但是参数无法传递，所以一定要选择全程跟随参数
![参数跟随](https://v3u.cn/v3u/Public/js/editor/attached/image/20200128/20200128090602_46135.png)