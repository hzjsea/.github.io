---
title: 邮件网关
date: 2021-01-12 14:12:45
categories:  [技术补充,]
tags: [技术补充,邮件,网关,linux]
---


<!--more-->


# 邮件网关

需求内容如下
1. 在linux上搭建一个邮件网关
2. 接收邮件，并使用python整理和格式化邮件，提取相关信息
3. 整合到数据库，用nodejs 调取内容
4. 前端调取nodejs上的内容，做成小程序


## 邮件网关



基础邮件原理

- MUA 邮件用户代理,向用户提供发送，接收和管理电子邮件的界面，比如outlook
- MTA 邮件传输代理,一般被称为邮件服务器软件，负责接收客户端软件发送的邮件，并将邮件传输给其他的MTA程序.
- MDA 邮件分发代理，负责在服务器中将邮件分发到用户的邮箱目录(默认情况下是/var/spool/mail/user)，它并不直接面向邮件用户，而是在后台默默的工作。有时候MDA的功能可以直接集成在MTA软件中，因此经常被忽略

> 邮件通信过程

![2021-01-12-15-14-35](http://noback.upyun.com/2021-01-12-15-14-35.png)

![2021-01-12-16-14-45](http://noback.upyun.com/2021-01-12-16-14-45.png)

1. 用户在邮件用户代理(MUA)上创建一个电子邮件，MUA包括QQ邮箱, outlook等等
2. 邮件创建完成点击发送之后，交给该用户的邮件传输代理(MTA) 发送的整个过程使用的都是SMTP协议
3. 在到达目的邮箱之前，需要经过多个MTA的转发，转发规则如下，同域邮箱之间直接使用MTA转发，不同域之间邮箱需要先使用DNS查找对端域的邮箱内容，然后再使用MTA进行转发。
4. 到达用户工作站的邮件服务器之后，会有最终的MTA接管这封邮件，将他交给服务器上的MDA，MDA是一个邮件分发代理，他会将这些邮件分别存放到对应的用户文件中去
5. 查收邮件，用户登录MUA 使用IMAP协议或者POP3协议来像邮件服务器查询邮件，这两个协议查询的姿势不一样,但查收邮件的方式大致相同，无非就是从邮件存储区域检索邮件列表，将列表和邮件头部(主题) 返回给MUA，点击头部后进入 会再次寻找对应的邮件返回。这里讲邮件投递给邮件服务器的就是Dovecot

作为IMAP和POP3服务器，Dovecot为邮件用户代理(MUA)提供了一种访问服务器上存储的邮件的方法。但是，Dovecot并不负责从其他邮件服务器接收邮件。Dovecot只是将已经存储在邮件服务器上的邮件通过MUA显示出来。

因此，邮件的接收，投递和存储，这些功能都是MTA也就是`Postfix`来提供的，MTA决定邮件是如何存放的，以及存放在哪里，Dovecot必须根据MTA的配置来进行相应的配置。而且很明显的是，在安装Dovecot之前，必须保证MTA正常工作。

> IMAP 与 POP3的查询姿势

- POP3通常用于网络连接慢的用户连接至邮件服务器，POP3的查询特征就是 MUA从服务器上下载邮件并保存在本地磁盘上，然后将服务器上的邮件删除
- IMAP通常用于局域网(LAN)或网络连接较快的用户，使用IMAP的目的就是只在每次有未读消息时才连接服务器（而不是使用类似于MUA的缓存）
- 现在基本上Dovecot用的就是IMAP了。POP3已经很少用了





> 邮件有关的协议，后缀有s的表示的是加上了ssl安全协议的协议，它们继承了SSL安全协议的非对称加密的高度安全可靠性，可防止邮件泄露。

之前有使用`sendmail`作为MTA，也就是传输代理，后面被`Postfix`替换
![2021-01-12-14-18-43](http://noback.upyun.com/2021-01-12-14-18-43.png)


邮箱有关的服务软件

- Postfix 是一个邮件传输代理软件 (MTA: Mail Transfer Agent)，支持 smtp 协议，主要用于接收和发送邮件。
- Dovecot 是一个本地邮件传输服务 (LMTP: Local Mail Transfer Protocol service)，支持 imap 和 pop3 协议，主要用于验证身份，方便客户端连接服务器发送和下载邮件


![2021-01-12-14-33-37](http://noback.upyun.com/2021-01-12-14-33-37.png)

## 使用
安装postfix,Dovecot
```bash
yum install postfix Dovecot mailx



# 发送邮件
echo 123 | mail -s test 'hzj@noback.top'
```



## 参考
https://zhuanlan.zhihu.com/p/38563496?utm_source=wechat_session&utm_medium=social&utm_oi=1025393882225328128&utm_campaign=shareopn

![postfix+Dovecot+mysql](https://cloud.tencent.com/developer/article/1326391)
![postfix+Dovecot+mysql](https://qizhanming.com/blog/2019/08/10/how-to-config-email-server-with-postfix-dovecot-and-mariadb-on-centos-7)