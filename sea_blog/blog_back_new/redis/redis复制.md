---
title: redis复制 
date: 2020-11-09 16:21:31   
categories: [redis,]  
tags: [redis,]
---


<!-- more -->


# redis复制
通常情况下，一个主机下面会有多个从机，而从机要成为某一个主机的从机的时候，需要建立连接

> 建立复制

```bash
# 方法1 ，修改配置
echo "slaveof 127.0.0.1 6379" >> redis.conf
# 方法2 启动的时候执行命令
redis-server redis-6526.conf --slaveof 127.0.0.1 6379
```

> 断开复制

```bash
slaveof no one 
```

> 切主操作

切主操作那个主要的流程就是
![2020-11-09-16-31-08](http://noback.upyun.com/2020-11-09-16-31-08.png)
1. 断开与旧主节点复制关系
2. 与新主节点建立复制关系
3. 删除从节点当前所有数据
4. 对新主节点进行复制操作

## 主从节点安全性
主节点设置了requirepass参数后，客户端需要使用auth来进行校验，才能连接上主节点

## 只读
默认情况下 从节点使用`slave-read-only=yes`配置为只读模式
由于复制只能从主节点到从节点，对于从节点的任何修改主节点都无法感知，修改从节点会造成主从数据不一致。因此建议线上不要修改从节点的只读模式。

## 传输延迟
主从节点一般部署在不同机器上，复制时的网络延迟就成为需要考虑的问题，Redis为我们提供了`repl-disable-tcp-nodelay`参数用于控制是否关闭TCP_NODELAY，默认关闭，说明如下：

- 当关闭时，主节点产生的命令数据无论大小都会及时地发送给从节点，这样主从之间延迟会变小，但增加了网络带宽的消耗。适用于主从之间的网络环境良好的场景，如同机架或同机房部署。
- 当开启时，主节点会合并较小的TCP数据包从而节省带宽。默认发送时间间隔取决于Linux的内核，一般默认为40毫秒。这种配置节省了带宽但增大主从之间的延迟。适用于主从网络环境复杂或带宽紧张的场景，如跨机房部署

跨机房部署与否主要取决于对抗容灾性的强硬性
如果要考虑高容灾性 则需要开启这个参数，并且使用跨机房部署

## redis从主拓扑

### 一主一从
当应用写命令并发量较高且需要持久化时，可以只在从节点上开启AOF，这样既保证数据安全性同时也避免了持久化对主节点的性能干扰。但需要注意的是，当主节点关闭持久化功能时，如果主节点脱机要避免自动重启操作。因为主节点之前没有开启持久化功能自动重启后数据集为空，这时从节点如果继续复制主节点会导致从节点数据也被清空的情况，丧失了持久化的意义。安全的做法是在从节点上执行slaveof no one断开与主节点的复制关系，再重启主节点从而避免这一问题。

### 一主多从
对于读占比较大的场景，可以把读命令发送到从节点来分担主节点压力。同时在日常开发中如果需要执行一些比较耗时的读命令，如：keys、sort等，可以在其中一台从节点上执行，防止慢查询对主节点造成阻塞从而影响线上服务的稳定性。对于写并发量较高的场景，多个从节点会导致主节点写命令的多次发送从而过度消耗网络带宽，同时也加重了主节点的负载影响服务稳定性。

### 树状主从
树状主从结构（又称为树状拓扑结构）使得从节点不但可以复制主节点数据，同时可以作为其他从节点的主节点继续向下层复制。通过引入复制中间层，可以有效降低主节点负载和需要传送给从节点的数据量。如图6-6所示，数据写入节点A后会同步到B和C节点，B节点再把数据同步到D和E节点，数据实现了一层一层的向下复制。当主节点需要挂载多个从节点时为了避免对主节点的性能干扰，可以采用树状主从结构降低主节点压力。