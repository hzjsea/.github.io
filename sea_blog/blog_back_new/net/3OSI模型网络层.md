---
title: OSI模型网络层
categories:
  - 网络
tags:
  - 网络
abbrlink: 89c636b0
date: 2020-07-23 15:21:51
---


<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [网络层](#网络层)
  - [网络层概述](#网络层概述)
    - [网络层中主要的两个功能](#网络层中主要的两个功能)
    - [转发表](#转发表)
  - [IPV4数据报](#ipv4数据报)
  - [网络层:数据平面](#网络层数据平面)
  - [网络层:控制平面](#网络层控制平面)
    - [控制平面 传统的方法](#控制平面-传统的方法)
    - [控制平面 SDN方法](#控制平面-sdn方法)
  - [网络服务模型](#网络服务模型)
    - [尽力而为的服务](#尽力而为的服务)
    - [分组交换机的种类](#分组交换机的种类)
    - [路由器工作原理](#路由器工作原理)
  - [软件定义网络SDN](#软件定义网络sdn)

<!-- /code_chunk_output -->
<!--more -->


# 网络层

网络层的两个平面，为了更好地理解网络层，通常将网络层区分成两个不同的平面来看到
```bash
1. 数据平面
网络层中每台路由器的功能，该平面决定到达路由器输入链路之一的数据报如何转发到路由器的输出链路
2. 控制平面
即网络范围的逻辑，改控制平面功能控制数据报沿着从源主机到目的主机的端到路径中路由器之间的路由方式。这之间需要设计到路由选择算法，包括OSPF以及BGP
```

:::  tip 
在我的初步感觉中，我认为数据平面就是路由器内部实现的功能
而控制平面则是多台路由器之间的交互实现功能，
也就是说一个控制平面中应该涵盖了大量的数据平面
但他们所实现的效果和功能是不同的
:::

每台路由器的数据平面的主要作用就是从其输入链路向其输出链路转发数据报。
控制平面的主要作用是协调这些本地的路由器转发动作，使得数据报沿着源和目的地主机之间的路由器路径最终进行端到端的传送

路由器具有截断的协议栈，即没有网络层以上的部分

源主机到路由器再到运营商路由后到目的主机的过程
```mermaid
graph LR
    Server1 --> R1 --> ISP --> R2 --> Server2
```

## 网络层概述


### 网络层中主要的两个功能

- 转发功能
转发是在数据平面实现的唯一功能。也就是当路由器收集到一个分组的时候，他需要将分组移动到适当的输出链路，我们将这一行为称之为转发。另外分组的过程中可能会被路由器阻挡，阻挡的原因有很多种(发现来源为已知的恶意主机)
- 路由选择
路由选择在网络层的控制平面实现。对于有多条路径的，路由器还必须完成一个路由选择的功能。当分组从发送方流向接收方的时候，网络层需要决定这些分组所采用的路由和路径。计算这些路径的算法被称为`路由

转发是指将分组从一个输入链路接口转移到适当的输出链路接口的路由器本地动作  `转发的发生时间尺度很短，通常为几纳秒 因此用硬件来实现`
路由选择是指确定分组从源目的地所采取的端到端路径的网络范围处理过程。`路由选择发生的时间尺度很长，因此用软件来实现`

### 转发表
每台路由器都有一个`转发表`, 路由器检查到达分组首部的一个或多个字段值，然后用这些首部的值去自己的转发表中索引，最后得到转发的下一跳,整个过程就是`分组转发`
索引到的内容主要包括该分组被转发的路由器的输出链路接口  P200

路由表
![2020-07-26-22-18-33](http://noback.upyun.com/2020-07-26-22-18-33.png)




## IPV4数据报
![2020-07-27-11-44-24](http://noback.upyun.com/2020-07-27-11-44-24.png)

首部长度计算，因为首部里面分为固定长度和选项部分，所以首部长度会存在最大值和最小值。
首先来计算一下最小值，也就是固定部分，固定部分一共分为5层 层占32bit也就是每层占4B(字节),所以最小为4*5=20字节，因此首部长度最小字节为20字节。
接着来计算最大值，也就是加上可变长度的部分。这里要根据首部长度的比特来计算，首部长度是占4bit，能表示的最大长度为1111 能表示的最大值为15 ，所以15个32bit所占的字节为60字节

感觉这里的首部长度 还不如看成首部层数比较好理解，可能有人会说这样的话，4bit最小能表示的不是00001 也就是1 嘛 那1个32bit也就是4字节，其实不是这样的，最小长度应该是他的固定部分的长度，也就是20字节

因此IPV4数据报首部长度的的范围是20-60字节


## 网络层:数据平面
上面有讲过，`网络层中数据平面的功能就是网络层中每台路由器的功能` 该数据平面功能决定到达路由器输入链路之一的数据报(即网络层的分组)是如何转发到该路由器的输出链路的


## 网络层:控制平面
`网络层控制平面即指网络范围的逻辑`即控制平面功能控制数据报沿着从源主机到目的主机的端到端路径中路由器之间的路由方式。这其中就涉及了路由选择算法，最突出的两个路由选择算法为 OSPF和BGP两种路由方式

### 控制平面 传统的方法
![2020-08-04-17-53-47](http://noback.upyun.com/2020-08-04-17-53-47.png)
路由选择算法决定了插入该路由器转发表的内容。路由选择算法运行在每台路由器中，并且在每台路由器中都包含转发和路由选择两种功能
在一台路由器中的路由选择算法与在其他路由器中的路由选择算法通信吗,以计算出他的转发表的值

路由选择算法的出现的的确确简化了人们的操作，同时也对网络拓扑的稳定性进行了巩固
人工配置容易出错，并且对于网络拓扑变化的响应比起路由选择协议来的更慢



### 控制平面 SDN方法
![2020-08-04-17-53-58](http://noback.upyun.com/2020-08-04-17-53-58.png)
https://riboseyim.github.io/2017/08/22/SDN-OpenFlow/
::: danger 
了解到SDN的具体过程很复杂，需要自己开发控制器，使用openflow去下发配置
后面有兴趣再具体了解
:::

远程控制器计算和分发转发表以供每台路由器所使用，相较于传统方法，路由选择设备仅执行转发，而远程控制器计算并分发转发表

出现场景: 远程控制器可能实现在具有高可靠性和冗余的远程数据中心，并可能由ISP或某些第三方管理。
路由器和控制器之间的通信方式，通过交换包含转发表和其他路由选择信息的报文
控制平面方法是软件定义网络的本质。计算转发表并与路由器交互的控制器是用软件实现的。因此网络是"软件定义"的


## 网络服务模型
网络服务模型定义了分组在发送和接收端系统之间的端到端的运输特性

### 尽力而为的服务
因特网的网络层仅提供单一的服务，叫做`尽力而为服务`,该服务使得传送的分组既不能保证以他们发送的顺序被接收，也不能保证他们最终被交付，既不能保证端到端的时延，也不能保证有最小的带宽。

### 分组交换机的种类
分组交换机是指一台通用的分组交换设备，他根据分组首部字段中的值，从输入链路接口到输出连口接口转移分组。
- 链路层交换机(2层设备) 基于链路层帧中的字段值做出转发决定
- 路由器(3层设备) 基于网络层数据报中的首部字段做出转发决定

### 路由器工作原理

路由表
![2020-07-26-22-18-33](http://noback.upyun.com/2020-07-26-22-18-33.png)
路由选择、路由选择算法、分组转发
![2020-07-26-22-23-54](http://noback.upyun.com/2020-07-26-22-23-54.png)



## 软件定义网络SDN
SDN的主要作用是分离数据平面和控制平面，将控制平面功能置于一台远程的"控制器"中，也就是类似于"商湾"这样的工作内容
