---
title: 网络部署需求分析
categories: 
  - 网络
abbrlink: 291d4679
tags: 
  - 网络
date: 2020-01-04 10:22:09
---



<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [网络部署需求分析](#网络部署需求分析)
  - [基础配置](#基础配置)
  - [取消Telnet 授权登录](#取消telnet-授权登录)
  - [6520需要开启的配置](#6520需要开启的配置)
  - [5820系列的交换机需要在本地生成sshkey](#5820系列的交换机需要在本地生成sshkey)
  - [***二层环路检测配置](#二层环路检测配置)
  - [自动生成汇聚端口配置脚本](#自动生成汇聚端口配置脚本)
  - [ipv6配置](#ipv6配置)
  - [### 西安光通高防 ipv6配置](#-西安光通高防-ipv6配置)
    - [四川成华移动机房](#四川成华移动机房)
  - [check-list](#check-list)

<!-- /code_chunk_output -->

<!-- more -->

# 网络部署需求分析


## 基础配置 
> 内网的交换机不需要配置acl2000

```bash
int LoopBack 3
description jump

sysname user-setting
local-user admin class manage
 service-type ssh
 authorization-attribute user-role level-3
 authorization-attribute user-role network-admin
 authorization-attribute user-role network-operator
#
local-user root class manage
 service-type ssh
 authorization-attribute user-role level-3
 authorization-attribute user-role network-admin
 authorization-attribute user-role network-operator
 quit

user-interface vty 0 4
authentication-mode scheme       
 user-role network-admin
protocol inbound all
quit


sysname pubkey-setting
public-key peer pub
  public-key-code begin	
   30820122300D06092A864886F70D01010105000382010F003082010A0282010100D37D67EC
   5A9466CD38895097E74386EBBEFA9EC59236DF5E96D7514B2903C21F09C6D47D74792B5E3D
   C1F99DB4D43614AE3AD61DEFFAF35CED9B94DBD85DE174598C491FA043F8C700DA686BFFCA
   227E4E7417A251CD7590673B4C1A227962F65CBA6017329479484EF8FE48A8E2FED636C846
   5765801A0D62C821906FF8E7188DA69D716FD392E8C0D4D0618E9020670FFA24CF083E2EF7
   690EABCA43AA4341D798A72B6FFB5A0A1BEF0F4B14B6B66E5F7126582BD11A11F4220EA3FF
   C1A5DF36E86E76A8EF6A97949158F094CBAD09725069A090CBA36D95CB6A9531A5AB8B3ED5
   8D6C63C8138320F0F1ECD7B25203A1B79FC82635B0F53475BC428B3B741F0203010001
  public-key-code end
 peer-public-key end


public-key peer upyun
 public-key-code begin
   30820122300D06092A864886F70D01010105000382010F003082010A0282010100BEF4DB4E
   5224F5FFE95AF67CC1753592979F6C1379E0A1FB8519C0E6E626B50F221957806B64384173
   F2B370254381D583D3EC70D4211CC599CF6C1615754E985895D1E78E1E62788A9BC2E4D2EB
   55A18FD20D2B692813114C650FE4FC883DB5467039264C2478332C2C967F3DAE83AFBDFAB3
   D794F38DCB2E112184127A151741947DFBB00E8E66B9037131C54A27DE703B2E80A3D8D3C6
   79CFC9E851D9C76610228790D7E2253D7E7735481D2EA61AA71D6DFD2EAC037203CE08943E
   43DF88AC1ECCB77433358B5ABDF080616D6B6C40AEBEEEDD64D8B8718F091CAA0EA8D5A6A0
   2B6106D931E45717C94DBC0F3FF6608CB609C4DA4860C8C48EE67CB304470203010001
 public-key-code end
 peer-public-key end


sysname pubkey-general
ssh user admin service-type stelnet authentication-type publickey assign publickey pub
ssh user root service-type stelnet authentication-type publickey assign publickey upyun


sysname acl-setting
acl number 2000
description Login IP Control
rule 0 permit source 192.168.0.0 0.0.255.255
rule 5 permit source 10.0.0.0 0.255.255.255
rule 10 permit source 122.224.83.128 0.0.0.63
rule 15 permit source 124.160.136.128 0.0.0.63
rule 20 permit source 112.13.110.128 0.0.0.63
rule 25 permit source 115.231.100.64 0.0.0.63
rule 30 permit source 121.52.226.192 0.0.0.63
rule 35 permit source 112.17.251.0 0.0.0.63
rule 40 permit source 218.205.64.0 0.0.0.31
rule 45 permit source 183.131.12.16 0.0.0.15
rule 50 permit source 115.231.97.0 0.0.0.31
rule 55 permit source 101.251.144.0 0.0.0.31
rule 60 permit source 112.13.172.96 0.0.0.31
rule 65 permit source 112.13.174.0 0.0.0.31
rule 70 permit source 183.136.236.224 0.0.0.31
rule 75 permit source 43.230.89.160 0.0.0.31
rule 80 permit source 129.227.137.224 0.0.0.31
rule 1000 deny source any
quit
int loopback 3
quit


sysname acl-setting
acl number 3010
description DAMS Counter ACL Inbound
rule 100 permit tcp syn 1
rule 110 permit tcp ack 1
rule 120 permit tcp rst 1
rule 199 permit tcp psh 1
rule 199 comment ########## TCP FLAGs ##########
rule 2010 permit udp source 8.8.8.8 0 source-port eq dns
rule 2011 permit udp source 114.114.114.114 0 source-port eq dns
rule 2012 permit udp source 223.5.5.5 0 source-port eq dns
rule 2013 permit udp source 180.76.76.76 0 source-port eq dns
rule 2014 permit udp source 119.29.29.29 0 source-port eq dns
rule 2015 permit udp source 1.2.4.8 0 source-port eq dns
rule 2015 comment ########## PUB DNS ##########
rule 2101 permit udp source 106.14.167.4 0 source-port eq dns
rule 2102 permit udp source 123.56.81.171 0 source-port eq dns
rule 2103 permit udp source 139.155.15.2 0 source-port eq dns
rule 2104 permit udp source 106.55.157.188 0 source-port eq dns
rule 2105 permit udp source 39.134.135.103 0 source-port eq dns
rule 2106 permit udp source 39.135.1.138 0 source-port eq dns
rule 2106 comment ########## UPDNS ##########
rule 2200 permit udp destination-port eq dns
rule 2510 permit udp source-port eq ntp
rule 2520 permit udp destination-port eq ntp
rule 2530 permit udp source-port eq syslog
rule 2540 permit udp destination-port eq syslog
rule 2550 permit udp source-port eq snmp
rule 2560 permit udp destination-port eq snmp
rule 2570 permit udp source-port eq 1234
rule 2580 permit udp destination-port eq 1234
rule 3010 deny udp source-port eq dns
rule 3020 deny udp source-port eq 1900
rule 3030 deny udp source-port eq 11211
rule 15000 permit udp
rule 15000 comment ########## UDP ##########
rule 65000 permit ip
quit
int loopback 3
quit



sysname snmp-setting
snmp-agent
snmp-agent local-engineid 800063A203
snmp-agent community read hgE6ofdZ3b
snmp-agent sys-info version v2c v3 
int loopback 3
quit

sysname clock-setting
interface Vlan-interface1
ntp-service unicast-server 218.189.210.4 source Vlan-interface 1
ntp-service unicast-server 137.189.4.10 source Vlan-interface 1
ntp-service unicast-server 115.231.97.11 source Vlan-interface 1
ntp-service unicast-server 115.231.97.11 source Vlan-interface 1
ntp-service enable
clock timezone beijing add 8


sysname ttl-setting
ip ttl-expires enable
ip unreachables enable
ipv6 unreachables enable
int loopback 3
quit
loopback-detection global enable vlan all
shutdown-interval 120 
loopback-detection interval-time 5
int loopback 3
quit


sysname baseserver-setting
undo copyright-info enable
ssh server enable
ssh server acl 2000
undo ip http enable
undo stp global enable
undo info-center enable
int loopback 3
quit

sysname dynamic-bridge-setting

interface bridge-aggregation 1
interface  Ten-GigabitEthernet1/0/1
port link-aggregation group 1
interface Ten-GigabitEthernet1/0/2
port link-aggregation group 1

interface bridge-aggregation 2
interface  Ten-GigabitEthernet1/0/3
port link-aggregation group 2
interface Ten-GigabitEthernet1/0/4
port link-aggregation group 2

interface bridge-aggregation 3
interface  Ten-GigabitEthernet1/0/5
port link-aggregation group 3
interface Ten-GigabitEthernet1/0/6
port link-aggregation group 3

interface bridge-aggregation 4
interface  Ten-GigabitEthernet1/0/7
port link-aggregation group 4
interface Ten-GigabitEthernet1/0/8
port link-aggregation group 4

interface bridge-aggregation 5
interface  Ten-GigabitEthernet1/0/9
port link-aggregation group 5
interface Ten-GigabitEthernet1/0/10
port link-aggregation group 5

interface bridge-aggregation 6
interface  Ten-GigabitEthernet1/0/11
port link-aggregation group 6
interface Ten-GigabitEthernet1/0/12
port link-aggregation group 6

interface bridge-aggregation 7
interface  Ten-GigabitEthernet1/0/13
port link-aggregation group 7
interface Ten-GigabitEthernet1/0/14
port link-aggregation group 7

interface bridge-aggregation 8
interface  Ten-GigabitEthernet1/0/15
port link-aggregation group 8
interface Ten-GigabitEthernet1/0/16
port link-aggregation group 8

interface bridge-aggregation 9
interface  Ten-GigabitEthernet1/0/17
port link-aggregation group 9
interface Ten-GigabitEthernet1/0/18
port link-aggregation group 9

interface bridge-aggregation 10
interface  Ten-GigabitEthernet1/0/19
port link-aggregation group 10
interface Ten-GigabitEthernet1/0/20
port link-aggregation group 10

interface bridge-aggregation 11
interface  Ten-GigabitEthernet1/0/21
port link-aggregation group 11
interface Ten-GigabitEthernet1/0/22
port link-aggregation group 11

interface bridge-aggregation 12
interface  Ten-GigabitEthernet1/0/23
port link-aggregation group 12
interface Ten-GigabitEthernet1/0/24
port link-aggregation group 12

interface bridge-aggregation 13
interface  Ten-GigabitEthernet1/0/25
port link-aggregation group 13
interface Ten-GigabitEthernet1/0/26
port link-aggregation group 13

interface bridge-aggregation 14
interface  Ten-GigabitEthernet1/0/27
port link-aggregation group 14
interface Ten-GigabitEthernet1/0/28
port link-aggregation group 14

interface bridge-aggregation 15
interface  Ten-GigabitEthernet1/0/29
port link-aggregation group 15
interface Ten-GigabitEthernet1/0/30
port link-aggregation group 15


int loopback 3
quit

sysname disable old setting
undo int loopback 3
info-center enable

sysname baseserver-setting
info-center enable
undo copyright-info enable
ssh server enable
ssh server acl 2000
undo ip http enable
undo stp global enable
int loopback 3
quit



sysname success
```

## 取消Telnet 授权登录
```bash
system-view
ssh server enable
undo telnet server enable
local-user root class manage
undo password
undo service-type  telnet
local-user admin class manage
undo password
undo service-type  telnet
quit
save force
```

## 6520需要开启的配置
```bash
max-ecmp-num 64
ecmp mode enhanced
save force
quit 
reboot
```

## 5820系列的交换机需要在本地生成sshkey
```bash
public-key local create rsa 
# 不断回车就行了
```

## ***二层环路检测配置
h3c 5130配置
```bash
loopback-detection global enable vlan all
# 端口定时器
shutdown-interval 120 
# 环路检测报文发送周期  
loopback-detection interval-time 5

# 接口内部配置
# 环路检测接口配置
loopback-detection action shutdown
loopback-detection enable vlan all
```

h3c 5120配置\ 6300配置
```bash
loopback-detection multi-port-mode enable
loopback-detection enable
# 端口定时器
shutdown-interval 120 
# 环路检测报文发送周期
loopback-description interval-time 5

# 接口内配置
# 环路检测接口配置
loopback-detection action shutdown
loopback-detection enable vlan all
```

h3c 5820配置/6800配置
```bash
loopback-detection global enable vlan all
# 端口定时器
shutdown-interval 120 
# 环路检测报文发送周期
loopback-detection interval-time 5

# 接口内部配置
# 环路检测接口配置
loopback-detection global action shutdown
loopback-detection global enable vlan all
```

## 密码复杂度
新版本的交换机当中，对密码复杂度有了一定的要求，为了适配老版本的密码规则，需要设置一下
分别是设置密码类型，以及密码程度
```bash
password-control composition type-number 1
# admin admin 
password-control length 5
# admin upyun123
password-control length 8
# undo check username
undo password-control complexity user-name check
```


## 自动生成汇聚端口配置脚本
```py
import os
import json

# 指定端口类型  有些做过堆叠的交换机 MemberID是不同的
port_type = "1"

for i in range(1,16):
    print("interface bridge-aggregation %s"%i)
    print("interface GigabitEthernet%s/0/%s"%(port_type,int(i*2-1)))
    print("port link-aggregation group %s"%i)
    print("interface GigabitEthernet%s/0/%s"%(port_type,int(i*2)))
    print("port link-aggregation group %s"%i)


## REANME.md
##交换机的配置需要批量配置管理端口
##用这个脚本生成就ok了
```


## ipv6配置
### 西安光通高防 ipv6配置
-------
要求
西安光通高防  
业务ipv6  240e:bf:b800:1900::/64   
互联 对端:240e:bf:b800:19ff::100/127 公司:240e:bf:b800:19ff::101/127

```bash
# 先配置互联地址，看和机房是否互通，默认vlan1为业务vlan ,其他vlan为互联vlan
[CTN-SN-XIY-S01]dis int brief
Brief information on interfaces in route mode:
Link: ADM - administratively down; Stby - standby
Protocol: (s) - spoofing
Interface            Link Protocol Primary IP      Description
InLoop0              UP   UP(s)    --
NULL0                UP   UP(s)    --
Vlan1                UP   UP       1.81.5.161
Vlan10               DOWN DOWN     --
Vlan101              UP   UP       192.168.100.2

# 配置互联地址
Interface vlan-interface 101
ipv6 address 240e:bf:b800:19ff::101/127 

# 测试互联是否互通
ping ipv6 240e:bf:b800:19ff::100


# 配置业务地址和静态路由
interface vlan-interface 1
ipv6 address 240e:bf:b800:1900::1/64
undo ipv6 nd ra halt

# 配置静态路由
ipv6 route-static :: 0 240e:bf:b800:19ff::100
 
```
--------

### 四川成华移动机房

--------
要求
四川成华移动机房（自有节点） 
IPV6资源：2409:8C62:410:6::/64，
互联： 对端2409:8062:3000:0201:: C/127 公司2409:8062:3000:0201:: D/127 
      对端2409:8062:3000:0202:: 6/127 公司2409:8062:3000:0202:: 7/127

```bash
<CMN-SC-CTU4-S01>dis int brief
Brief information on interfaces in route mode:
Link: ADM - administratively down; Stby - standby
Protocol: (s) - spoofing
Interface            Link Protocol Primary IP      Description
Vlan1                UP   UP       117.172.22.129
Vlan200              UP   UP       117.172.4.50
Vlan201              UP   UP       117.172.4.54

# 配置互联地址
interface Vlan-interface200
 ip address 117.172.4.50 255.255.255.252
 ipv6 address 2409:8062:3000:201::D/127
interface Vlan-interface201
 ip address 117.172.4.54 255.255.255.252
 ipv6 address 2409:8062:3000:202::7/127

# 测试互联
ping ipv6 2409:8062:3000:201::C
ping ipv6 2409:8062:3000:202::6

# 配置业务vlan
interface Vlan-interface1
 ip address 117.172.22.129 255.255.255.224
 ipv6 address 2409:8C62:410:6::1/64
 undo ipv6 nd ra halt

# 配置静态
[CMN-SC-CTU4-S01]dis current-configuration | include ipv6.ro
 ipv6 route-static :: 0 2409:8062:3000:201::C
 ipv6 route-static :: 0 2409:8062:3000:202::6

# 测试路由
<CMN-SC-CTU4-S01>tracert ipv6 2409:8062:3000:201::C
traceroute to 2409:8062:3000:201::C (2409:8062:3000:201::C), 30 hops at most, 60 byte packets, press CTRL_C to break
 1  2409:8062:3000:201::C  2.934 ms  2.345 ms  2.336 ms
<CMN-SC-CTU4-S01>tracert ipv6 2409:8062:3000:202::6
traceroute to 2409:8062:3000:202::6 (2409:8062:3000:202::6), 30 hops at most, 60 byte packets, press CTRL_C to break
 1  2409:8062:3000::202  3.957 ms  3.125 ms  3.879 ms

# 测试外网能否访问

```

![2020-01-09-11-01-29](http://noback.upyun.com/2020-01-09-11-01-29.png)

-------


## check-list
ipv6配置完成以后需要确认内容
1. 测试互联是否正确，ping ipv6 对端互联ip
2. 业务地址是否配了 undo ipv6 nd ra halt
3. 静态路由配置以后是否正确，本地是否通，外网是否通
这里以西安高防为例子，
如果是内网机器，比如互联ip是fe这种，那就是内网机器，找cdn那边要机器测
mtr ipv6 240e:bf:b800:1900::1
如果是外网机器，找其他的交换机测  
tracert ipv6 240e:bf:b800:1900::1 

<font color='red'>另外还要注意的是如果掩码是/72的只能自己分配ip不能dhcp</font> 
