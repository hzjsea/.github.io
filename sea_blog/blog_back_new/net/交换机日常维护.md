---
title: h3c交换机实例
categories:
  - 网络
tags:
  - 网络
abbrlink: '70316350'
date: 2020-03-17 11:01:27
---
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [h3c交换机实例](#h3c交换机实例)
  - [查看流量](#查看流量)
  - [根据提供IP查找具体机器](#根据提供ip查找具体机器)
  - [交换机下架流程](#交换机下架流程)
  - [inventory上架流程](#inventory上架流程)
  - [更换IP](#更换ip)
  - [查看端口占用比](#查看端口占用比)
  - [重置交换机](#重置交换机)
  - [交换机撤口流程](#交换机撤口流程)
  - [交换机三线端口](#交换机三线端口)
  - [查找交换机下面对应的机器](#查找交换机下面对应的机器)
  - [查找某一个汇聚口下面的接口](#查找某一个汇聚口下面的接口)
  - [回收接口](#回收接口)
  - [查看端口上的流量](#查看端口上的流量)
  - [查看交换机上下联状态](#查看交换机上下联状态)
  - [mac地址显示与维护](#mac地址显示与维护)
  - [H3C交换机查看SN(产品序列号)](#h3c交换机查看sn产品序列号)
  - [H3C交换机风扇方向修改](#h3c交换机风扇方向修改)
  - [H3C交换机查看光衰](#h3c交换机查看光衰)

<!-- /code_chunk_output -->
<!-- more -->


# h3c交换机实例


## 查看流量
扩容端口之后需要查看端口的流量是否匀过去
扩容端口的方式有一下集中
1. 直接新建互联透传  access vlan 
2. 写入汇聚口 动态

两种方式最好先配置好端口的配置,第二种需要与汇聚口的配置方式相同,然后shutdown,等对端配置好了以后,再开起来

扩容完成以后要看流量有没有匀过去
```bash
dis  c r i i 
```

## 根据提供IP查找具体机器

解决思路，arp中找到具体的IP表象，根据arp中的mac地址，找到对应的网口，再由机房找到对应的机器
![2020-03-17-11-05-31](http://noback.upyun.com/2020-03-17-11-05-31.png)
![2020-03-17-11-06-20](http://noback.upyun.com/2020-03-17-11-06-20.png)
如果出现Bridge 有两种情况 一种是汇聚口，一种是互联口，如果是互联口再根据互联IP找到对应的上联机器
![2020-03-17-11-08-20](http://noback.upyun.com/2020-03-17-11-08-20.png)
<font color='red'>如果没有arp ，Ping一下就会生成</font>

## 交换机下架流程

- 首先知道哪些机器要下架,知道以后登陆上去看一下交换机上下是不是有机器还连在上面，可以让机房帮忙看一下
- 查看接口的流量
dis int bri xxx
![2020-01-10-15-17-26](http://noback.upyun.com/2020-01-10-15-17-26.png)
像这种没多少流量的基本上就是没有机器了
- 找到机柜 交换机型号 发给商务，
- 商务发工单给机房下架 
- 完事

## inventory上架流程

- 拉取项目
git clone https://gitlab.s.upyun.com/infrastructure/inventory.gigit clone https://gitlab.s.upyun.com/infrastructure/inventory.git
- 查看当前分支
git branch
- 切换分支
git checkout hzj
- 修改内容
...
- 上传
git commit -am "update"
git push 
到web端创建合并请求
- 更新
首先切换到master `git checkout master`
拉取最新` git pull`  
切换次分支 `git checkout hzj`
合并更新分支到hzj分支 `git merge origin hzj`
发消息给有master权限的人，交由master来合并


## 更换IP
1. 确定是否能够更换
2. 配置subIP 等待更换，更换结束之后测试通。
3. 等待业务切量，将流量切到subip上面
4. 取消之前的mastr ip  直接undo 
5. 取消sub  重新打一遍就行了

```bash
# 配置从IP
ip address 192.168.20.2 255.255.255.252 sub
# 取消sub
ip address 192.168.20.2 255.255.255.252
```

## 查看端口占用比
`dis interface ten1/0/48`
![2020-03-19-10-31-23](http://noback.upyun.com/2020-03-19-10-31-23.png)

CR冗余
在数据传输过程中，无论传输系统的设计再怎么完美，差错总会存在，这种差错可能会导致在链路上传输的一个或者多个帧被破坏(出现比特差错，0变为1，或者1变为0)，从而接受方接收到错误的数据。为尽量提高接受方收到数据的正确率，在接收方接收数据之前需要对数据进行差错检测，当且仅当检测的结果为正确时接收方才真正收下数据。检测的方式有多种，常见的有奇偶校验、因特网校验和循环冗余校验等。循环冗余校验是一种用于校验通信链路上数字传输准确性的计算方法（通过某种数学运算来建立数据位和校验位的约定关系的 [1]  ）。发送方计算机使用某公式计算出被传送数据所含信息的一个值，并将此值 附在被传送数据后，接收方计算机则对同一数据进行 相同的计算，应该得到相同的结果。如果这两个 CRC结果不一致，则说明发送中出现了差错，接收方计算机可要求发送方计算机重新发送该数据
如果CRC过高说明传输上有问题，可以更换模块解决，更换模块之后，需要重置端口的统计信息
```bash
reset counters int int-type int-number
```
## 重置交换机
`reset saved-configuration`


## 交换机撤口流程
撤口就是撤的上联口，可能不需要那么的流量了之类的 进去找对应的交换机
然后找互联口，从前往后撤口就行了

比如现在济南移动要撤一个口
登陆济南移动,找到上联口
![2020-03-23-17-38-28](http://noback.upyun.com/2020-03-23-17-38-28.png)
![2020-03-23-17-38-48](http://noback.upyun.com/2020-03-23-17-38-48.png)
另外还要把这个口对应的互联IP也发出去
![2020-03-23-17-40-52](http://noback.upyun.com/2020-03-23-17-40-52.png)

```
1/0/47 
223.99.239.218/30
2409:8C3C:FF:4::13/126
```


## 交换机三线端口
先找到对应的交换机，这个很难找
![2020-03-24-12-42-30](http://noback.upyun.com/2020-03-24-12-42-30.png)
然后知道三线的IP，三线指的就是三个运营商 分别是移动联通电信
```
XGE1/0/46            UP   10G(a)  F(a)   A    10                    CTN-UPLINK
XGE1/0/47            UP   10G(a)  F(a)   A    20                    CUN-UPLINK
BAGG100              UP   20G(a)  F(a)   A    100                   CMN-UPLINK
↓
XGE1/0/1             UP   10G(a)  F(a)   A    100
XGE1/0/2             UP   10G(a)  F(a)   A    100
```
然后他互联IP也给他们 在vlan1或者loop中


## 查找交换机下面对应的机器
都要使用mac地址去寻找机器，mac地址是二层里面的
二层之间只有mac地址 ，没有ip
你用dis arp + ip 会出来一个mac地址，这个mac地址就是机器的mac地址，不是这台交换机专门为他分配的mac地址
```bash
[CTN-ZJ-LNA-S01]dis arp 183.131.24.28
  Type: S-Static   D-Dynamic   O-Openflow   R-Rule   M-Multiport  I-Invalid
IP address      MAC address    VLAN     Interface                Aging Type
183.131.24.28   10c3-7b49-4886 80       BAGG110
```
根据mac地址找对应的机器
```bash
dis mac-address 10c3-7b49-4886 
[CTN-ZJ-LNA-S03]dis mac-address 10c3-7b49-492e
MAC Address      VLAN ID    State            Port/NickName            Aging
10c3-7b49-492e   80         Learned          BAGG20                   Y
```


## 查找某一个汇聚口下面的接口
```bash
# 查找汇聚口20这个下面的的借口
dis link verbose bri 20
[CTN-ZJ-LNA-S03]dis link-aggregation verbose Bridge-Aggregation 20
Loadsharing Type: Shar -- Loadsharing, NonS -- Non-Loadsharing
Port Status: S -- Selected, U -- Unselected,
             I -- Individual, * -- Management port
Flags:  A -- LACP_Activity, B -- LACP_Timeout, C -- Aggregation,
        D -- Synchronization, E -- Collecting, F -- Distributing,
        G -- Defaulted, H -- Expired

Aggregate Interface: Bridge-Aggregation20
Aggregation Mode: Static
Loadsharing Type: Shar
Management VLAN : None
  Port             Status  Priority Oper-Key
--------------------------------------------------------------------------------
  GE1/0/39         S       32768    8
  GE1/0/40         S       32768    8
```

## 回收接口
> 月底需要关闭的4个端口，因为你们上联为聚合组，无法根据互联IP地址确定物理端口，为避免接口关闭错误导致业务流量异常，需要你们先关闭端口，默认时间定于4月1号凌晨，如需提前关闭，请提前联系

这里要回收接口，可以提前关闭的话就可以不用等到凌晨了
首先的话先看一下汇聚口的总带宽
![2020-03-27-18-10-03](http://noback.upyun.com/2020-03-27-18-10-03.png)
两个口上面都跑了50G的带宽，现在是下两个口 每个口占10G带宽，也就是只要最近的最高带宽不超过30G就可以提前shutdown
![2020-03-27-18-11-57](http://noback.upyun.com/2020-03-27-18-11-57.png)
![2020-03-27-18-12-36](http://noback.upyun.com/2020-03-27-18-12-36.png)
发现带宽是在20G左右浮动的  就可以直接下了

```bash
## CMN-AH-HNN-S01
192.168.133.242/30
1/0/38·
192.168.133.242/30
1/0/39

B100 38 39
最高跑到20G多一点，一共有50G 减掉两个没事的

B200 44 45  
最高也是跑到20G多一点 一共50G 减掉两个没事
192.168.133.246/30
1/0/44
192.168.133.246/30
1/0/45

## 笔记 
1. 下之前看看zabbix的流量图
2. 问一下CDN 早下到规定下的这段时间有无流量操作

## CMN-SD-TNA-S01
B130 
1/0/17
223.99.239.218/30
2409:8C3C:FF:4::13/126
最高3G 总共20G 去掉没事

```


## 查看端口上的流量
```bash
dis int Bri 100
dis int T 1/0/1

<9306-2>display interface XGigabitEthernet 2/0/0 
XGigabitEthernet2/0/0 current state : UP
Line protocol current state : UP
Description:connet to f5-2
Switch Port, PVID :    1, TPID : 8100(Hex), The Maximum Frame Length is 9216
IP Sending Frames' Format is PKTFMT_ETHNT_2, Hardware address is f84a-bf70-3d00
Last physical up time   : 2014-03-09 18:12
Last physical down time : 2014-03-09 18:12
Current system time: 2014-03-09 18:12
Port Mode: COMMON FIBER
Speed : 10000,  Loopback: NONE
Duplex: FULL,  Negotiation: DISABLE
Mdi   : NORMAL
Last 300 seconds input rate 1602936 bits/sec, 1784 packets/sec
Last 300 seconds output rate 1393224 bits/sec, 1732 packets/sec
Input peak rate 142352400 bits/sec, Record time: 2014-03-09 18:12
Output peak rate 136841800 bits/sec, Record time: 2014-03-09 18:12
Input:  26101952708 packets, 3055712267640 bytes
```
其中INPUT和OUTPUT部分就是交换机的进出口流量


## 查看交换机上下联状态  
```bash
dis link s
```
实例
```bash
[CMN-AH-HNN-S01]dis link s

AGG        AGG   Partner ID              Selected  Unselected  Individual  Share
Interface  Mode                          Ports     Ports       Ports       Type
--------------------------------------------------------------------------------
BAGG1      S     None                    2         0           0           Shar
BAGG2      S     None                    2         0           0           Shar
BAGG3      S     None                    2         0           0           Shar
BAGG4      S     None                    2         0           0           Shar
BAGG5      S     None                    2         0           0           Shar
BAGG10     S     None                    8         0           0           Shar
BAGG100    S     None                    5         3           0           Shar
BAGG200    S     None                    5         3           0           Shar
BAGG1000   S     None                    0         0           0           Shar
```

## mac地址显示与维护
```bash
# 显示mac地址表信息
display mac-address
# 显示MAC地址表动态表项的老化时间
display mac-address aging-time
# 显示MAC地址学习功能的使能状态
display mac-address mac-learning [ interface interface-type interface-number ]
# 显示MAC地址表的统计信息
display mac-address statistics
# 显示MAC地址迁移记录
display mac-address mac-move [ slot slot-number ] 
```

实例
```bash
[CMN-AH-HNN-S01]display mac-address
MAC Address      VLAN ID    State            Port/NickName            Aging
001e-67fb-8b3c   1          Learned          BAGG10                   Y
001e-67fb-a5b8   1          Learned          BAGG10                   Y
001e-67fb-a666   1          Learned          BAGG10                   Y
001e-67fb-af54   1          Learned          BAGG10                   Y
001e-67fb-b164   1          Learned          BAGG10                   Y
1ab1-8541-9f00   1          Learned          BAGG4                    Y
2264-8598-1883   1          Learned          BAGG10                   Y
5a04-5198-83bd   1          Learned          BAGG5                    Y
6c92-bf2e-8f44   1          Learned          BAGG10                   Y
6c92-bf2e-8f70   1          Learned          BAGG10                   Y
6c92-bf2e-8f74   1          Learned          BAGG10                   Y
6c92-bf2e-8fa4   1          Learned          BAGG10                   Y
6c92-bf34-5050   1          Learned          BAGG3                    Y
```


## H3C交换机查看SN(产品序列号)
```bash
dis device manuinfo
```
实例
```bash
[CMN-ZJ-WNZ-S01]display device manuinfo
 Slot 1 CPU 0:
DEVICE_NAME          : S6300-48S
DEVICE_SERIAL_NUMBER : 210235A1DUH178000073
MAC_ADDRESS          : 38AD-BE2F-AB08
MANUFACTURING_DATE   : 2017-08-17
VENDOR_NAME          : H3C
Fan 1:
DEVICE_NAME          : LSWM1FANSC
DEVICE_SERIAL_NUMBER : 210231A0WEH177000079
MANUFACTURING_DATE   : 2017-07-06
VENDOR_NAME          : H3C
Fan 2:
DEVICE_NAME          : LSWM1FANSC
DEVICE_SERIAL_NUMBER : 210231A0WEH177000167
MANUFACTURING_DATE   : 2017-07-06
VENDOR_NAME          : H3C
Power 1:
DEVICE_NAME          : LSVM1AC300
DEVICE_SERIAL_NUMBER : 210231A1SUH163002239
MANUFACTURING_DATE   : 2016-03-28
VENDOR_NAME          : H3C
Power 2:
DEVICE_NAME          : LSVM1AC300
```



## H3C交换机风扇方向修改
查看交换机风扇方向
![2020-06-01-10-26-35](http://noback.upyun.com/2020-06-01-10-26-35.png)
修改交换机风向
```bash
fan prefer-direction slot 1 port-to-power  # 转个方向就ok了
```


## H3C交换机查看光衰
查看单口的光衰
```bash
# dis tran dia int 1/0/1
[CMN-JS-YTY-S01]display transceiver diagnosis  interface Ten-GigabitEthernet 1/0/1
Ten-GigabitEthernet1/0/1 transceiver diagnostic information:
  Current diagnostic parameters:
    Temp.(C) Voltage(V)  Bias(mA)  RX power(dBm)  TX power(dBm)
    39         3.28        6.66      -3.14          -2.27
  Alarm thresholds:
          Temp.(C) Voltage(V)  Bias(mA)  RX power(dBm)  TX power(dBm)
    High  90         3.63        15.00     3.01           0.79
    Low   -10        2.97        1.00      -16.02         -7.97
```
上面的是当前的状态  下面的是标准值  只要在标准值内就OK了

查看单口的模块介绍
```bash
# dis tran int 1/0/1
[CMN-JS-YTY-S01]dis transceiver interface Ten-GigabitEthernet 1/0/1
Ten-GigabitEthernet1/0/1 transceiver information:
  Transceiver Type              : 10G_BASE_SR_SFP
  Connector Type                : LC
  Wavelength(nm)                : 850
  Transfer Distance(m)          : 80(OM2),20(OM1),300(OM3)
  Digital Diagnostic Monitoring : YES
  Vendor Name                   : H3C
  Ordering Name                 : SFP-XG-SX-MM850-A
```

查看单口的模块出厂属性
```bash
# dis tran manuinfo int 1/0/1
[CMN-JS-YTY-S01]dis transceiver manuinfo interface Ten-GigabitEthernet 1/0/1
Ten-GigabitEthernet1/0/1 transceiver manufacture information:
  Manu. Serial Number : 210231A0A6HCAF037457
  Manufacturing Date  : 2017-03-07
  Vendor Name         : H3C
```