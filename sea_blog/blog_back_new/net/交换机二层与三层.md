---
title: 交换机二层与三层
categories:
  - 网络
tags:
  - 网络
abbrlink: 9bb9b12b
date: 2020-01-12 19:11:22
---

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->
<!-- more -->

# 交换机配置与三层
## 图片笔记
![2020-01-12-19-13-26](http://noback.upyun.com/2020-01-12-19-13-26.png)
![2020-01-12-19-14-23](http://noback.upyun.com/2020-01-12-19-14-23.png)

## vlan间通信

二层交换机，只能在相同vlan间通信，因此在业务上配置二层交换机的同时，有多种配置的方法
1. 直接透传的形式
也就是在三层交换机下面直接下挂机器，二层交换机只做IP转发
2. 三层trunk的形式(间接透传)
trunk的形式则需要两端统一vlan ID信息，如果没有统一，trunk模式下会丢弃该内容，常用于多个vlan之间通信
3. 三层access模式
Access端口只属于1个VLAN，也可以用于多个vlan之间通信，但是这样就需要开启多个vlan，每个接口单独access一个vlan
如果交换机对端设置了dynamic,则本端也需要设置dynamic模式


## 动态汇聚于静态汇聚
静态汇聚方便，但是网络调整维护不方便，动态汇聚弹性，维护方便，受网络影响小

::: tip 
什么是链路聚合 
:::
首先需要明确链路聚合的概念：链路聚合是将两个或更多数据信道结合成一个单个的信道，该信道以一个单个的更高带宽的逻辑链路出现。链路聚合一般用来连接一个或多个带宽需求大的设备，例如连接骨干网络的服务器或服务器群

- 静态聚合模式：配置聚合的端口数量是固定的，聚合后的带宽也是固定的；
- 动态聚合模式：实际聚合的端口数量是根据流量策略动态调整的，聚合带宽也会随之变化。例如在低负载时有2个端口参与聚合，高负载时会有4个端口参与聚合，从而更好的满足应用的要求。
- 静态聚合，就是人工设定把多条信道分开或者合并
- 动态聚合就是系统自动分配信道



## 直接透传和间接透传

1. 直接透传(直接下挂)
就是某个数据包在两个直连链路的两个端口间传输，数据包的VLAN标记没有发生任何变化。
如两个直连的Trunk口，两个端口的PVID 都是vlan 1，VLAN 2的数据包从Trunk口A发送出来，被另一端的Trunk口B接收，收发之间，VLAN 2的数据包无任何改变。

2. 间接透传
就是数据包在两个直连端口链路间传输时，在两个端口收发时，数据包的VLAN标签会发生改变，但是最终数据包的VLAN还是没变。
如两个直连的Trunk口，两个端口的PVID 都是vlan 1，VLAN 1的数据包从Trunk口A发送出来，此时被剥除VLAN 1的信息，被另一端的Trunk口B接收，此时又被添加VLAN 1的信息。收发之间，VLAN 2的数据包先是被剥离VLAN信息，然后在接收端又被打上原先的VLAN1信息。
不管是哪种方式透传，透传的结果都是数据包的最终VLAN信息在经历端口收发后，都不改变。



## vlan与交换机端口模式Access，Hybrid，Trunk
VLAN（Virtual Local Area Network）的中文名为"虚拟局域网"。VLAN是一种将局域网设备从逻辑上划分成一个个网段，从而实现虚拟工作组的新兴数据交换技术。这一新兴技术主要应用于交换机和路由器中，但主流应用还是在交换机之中。但又不是所有交换机都具有此功能，只有VLAN协议的第二层以上交换机才具有此功能。802.1Q的标准的出现打破了虚拟网依赖于单一厂商的僵局，从一个侧面推动了VLAN的迅速发展。
交换机端口有三种工作模式，分别是Access，Hybrid，Trunk。
- Access类型的端口只能属于1个VLAN，一般用于连接计算机的端口；
- Trunk类型的端口可以允许多个VLAN通过，可以接收和发送多个VLAN的报文，一般用于交换机之间连接的端口；
- Hybrid类型的端口可以允许多个VLAN通过，可以接收和发送多个VLAN的报文，可以用于交换机之间连接，也可以用于连接用户的计算机。 
Hybrid端口和Trunk端口在接收数据时，处理方法是一样的，唯一不同之处在于发送数据时：Hybrid端口可以允许多个VLAN的报文发送时不打标签，而Trunk端口只允许缺省VLAN的报文发送时不打标签。

untag就是普通的ethernet报文，普通PC机的网卡是可以识别这样的报文进行通讯； 
tag报文结构的变化是在源mac地址和目的mac地址之后，加上了4bytes的vlan信息，也就是vlan tag头；一般来说这样的报文普通PC机的网卡是不能识别的 
因此对于Pc机来说，只允许使用在传输数据时，不带标签的模式access


### Access、Trunk、Hybrid三种端口模式接收发数据状态
在网络的分层结构和宽带的合理分配方面，TRUNK被解释为“端口汇聚”，是带宽扩展和链路备份的一个重要途径。TRUNK把多个物理端口捆绑在一起当作一个逻辑端口使用，可以把多组端口的宽带叠加起来使用。TRUNK技术可以实现TRUNK内部多条链路互为备份的功能，即当一条链路出现故障时，不影响其他链路的工作，同时多链路之间还能实现流量均衡，就像我们熟悉的打印机池和MODEM池一样。

![2020-01-12-23-01-30](http://noback.upyun.com/2020-01-12-23-01-30.png)
- Acess端口收报文:      
        收到一个报文,判断是否有VLAN信息：如果没有则打上端口的PVID，并进行交换转发,如果有则直接丢弃（缺省） 
- trunk端口收报文：       
        收到一个报文，判断是否有VLAN信息：如果没有则打上端口的PVID，并进行交换转发，如果有判断该trunk端口是否允许该 VLAN的数据进入：如果允许则报文携带原有VLAN标记进行转发，否则丢弃该报文。 
- hybrid端口收报文：       
        收到一个报文,判断是否有VLAN信息：如果没有则打上端口的PVID，并进行交换转发，如果有则判断该hybrid端口是否允许该VLAN的数据进入：如果可以则转发，否则丢弃

![2020-01-12-22-57-44](http://noback.upyun.com/2020-01-12-22-57-44.png)
- Acess端口发报文：
        将报文的VLAN信息剥离，直接发送出去 
- trunk端口发报文：
        比较端口的PVID和将要发送报文的VLAN信息，如果两者相等则剥离VLAN信息，再发送，否则报文将携带原有的VLAN标记进行转发。
- hybrid端口发报文：
        1、判断该VLAN在本端口的属性
        2、如果是untag则剥离VLAN信息，再发送，如果是tag则比较端口的PVID和将要发送报文的VLAN信息，如果两者相等则剥离VLAN信息，再发送，否则报文将携带原有的VLAN标记进行转发

## 什么是pvid
PVID英文为Port-base VLAN ID，是表示网络通信中基于端口的VLAN ID，一个端口可以属于多个VLAN，但是只能有一个PVID，收到一个不带tag头的数据包时，会打上PVID所表示的VLAN号，视同该VLAN的数据包处理
一个物理端口只能拥有一个PVID，当一个物理端口拥有了一个PVID的时候，必定会拥有和PVID相等的VID，而且在这个VID上，这个物理端口必定是Untagged Port。
PVID的作用只是在交换机从外部接受到可以接受Untagged 数据帧的时候给数据帧添加TAG标记用的，在交换机内部转发数据的时候PVID不起任何作用
https://baike.baidu.com/item/PVID
