---
title: 二层与三层
categories:
  - 网络
tags:
  - 网络
abbrlink: eb05326e
password: upyun123
date: 2020-05-28 18:13:05
---

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [二层与三层](#二层与三层)
  - [三层配置实例](#三层配置实例)
    - [江苏泰州三层交换机上架](#江苏泰州三层交换机上架)
    - [常州上线交换机](#常州上线交换机)

<!-- /code_chunk_output -->
<!-- more -->


# 二层与三层



## 三层配置实例
三层两种配置方式
- ip配置在接口上，这种情况下，需要交换机的端口开启`port link-mode route`也就是路由模式
- ip配置在对应的vlan上，然后在把接口归类到对应的vlan组里面，正常情况下电信vlan10 联通vlan20 移动vlan30

来说一下这两种配置的优缺点
<font color='red'>第一种配置在接口上的方法，不需要考虑上联与下联对应的vlan关系，但是这样管理上会有一些缺陷，比较麻烦</font>
<font color='blue'>第二种配置在对应vlan的方法，需要考虑上下联对应的vlan关系，但是这样在管理上很方便 统一处理</font> 

### 江苏泰州三层交换机上架

这里用第一种配置的方法

```bash
# 要求
# 业务vlan
移动：223.111.169.64/27 ；联通：112.83.191.80/27
# 互联
又拍云移动互联1：云下：10.200.3.145/30 又拍云：10.200.3.146/30
又拍云移动互联2：云下：10.200.3.149/30 又拍云：10.200.3.150/30
又拍云联通互联1：云下：10.200.3.153/30 又拍云：10.200.3.154/30
# 机器
需安排邮寄5台2U服务器到机房+1台5820X交换机，
```

![2020-05-28-19-36-26](http://noback.upyun.com/2020-05-28-19-36-26.png)


<font color='red'>配置</font>

```bash
# 1. 刷基础配置
# 2. 配置必须配置的内容，如关闭stp 开启loopback-detection等等
# 3. 配置汇聚，这个
# 上面的这些就不叙述了
undo info-center enable
undo stp enable

# 配置聚合口实例
interface Bridge-Aggregation 1
quit
int ten1/0/1
port link-Aggregation group 1
int ten1/0/2
port link-Aggregation group 2

# 22 23 24 配置互联
int ten1/0/22
port link-mode route
description CMN1
ip address 10.200.3.146 255.255.255.252
quit
int ten1/0/23
port link-mode route
description CMN2 
ip address  10.200.3.150 255.255.255.252
quit 
int ten1/0/24
port link-mode route
description CUN1
ip address 10.200.3.153 255.255.255.252
quit

# 配置业务vlan 接口版，所有业务ip都放在vlan1上面
int vlan-interface 1
description JS-TZ-CUN
ip address 223.111.169.65 255.255.255.224
ip address 112.83.191.81 255.255.255.224 sub
ip policy-based-route JS-TZ

# 配置路由，移动走静态，联通走策略
ip route-static 0.0.0.0 0 10.200.3.145
# 联通策略 acl 
# 过滤其他IP，只保留联通的流量包
acl number  2201
description JS-TZ-CUN
 rule 10 permit source 112.83.191.79 0.0.0.32
policy-based-route JS-TZ permit node 0
 if-match acl 2201
 apply next-hop 10.200.3.153
 # 如果没有用default-next-hop 就要全局定义
 # ip local policy-based-route JS-TZ

# 应用策略路由
int vlan-interface 1
ip policy-based-route JS-TZ
```

<font color='red'>我们是把业务vlan也充当管理vlan？</font>
<font color='red'>像上面这段如果是移动分开两端，那么静态路由是不是要写两个</font>

### 常州上线交换机
![2020-05-28-19-58-46](http://noback.upyun.com/2020-05-28-19-58-46.png)
![2020-05-28-20-18-24](http://noback.upyun.com/2020-05-28-20-18-24.png)
这里.1是对端
需求
```bash
# 互联
对端:10.103.36.1/30 本端:10.103.36.2/30
对端:10.102.45.1/30 本端:10.102.45.2/30
对端:10.130.33.1/30 本端:10.130.33.2/30
# 业务ip
电信:58.216.101.192/26
联通:103.45.78.0/25
移动:36.154.11.128/25
# 管理ip
10.32.1.254 255.255.255.0
# 机器
20台服务器汇聚接1-50口
4台服务器接拆分后的49-50口
一台6800交换机
```

配置
```bash

undo stp enable
undo info-center enable

max-ecmp-num 128 
ecmp mode enhanced
ip load-sharing symmetric enable # ospf负载均衡要加

# 机器汇聚
interface Bridge-Aggregation 1
quit
int ten1/0/1
port link-Aggregation group 1
int ten1/0/2
port link-Aggregation group 2

# 接口拆分  6800貌似不用重启就可以了但是58需要重启
int fo1/0/49
using tengige
int fo1/0/50
using tengige
interface Bridge-Aggregation 30
quit
int ten1/0/49:1 
port link-Aggregation group 30
int ten1/0/49:2
port link-Aggregation group 30
quit

# 配置互联
vlan 10 # 电信
vlan 20 # 联通 
vlan 30 # 移动
interface vlan-interface 10
ip address 10.103.36.2 255.255.255.252
interface vlan-interface 20
ip address 10.102.45.2 255.255.255.252
interface vlan-interface 30
ip address 10.130.33.2 255.255.255.252
## 将接口划到互联vlan组里面
int ten1/0/41
port access vlan 10 #究竟是access还是trunk这个要和对端确定
int ten1/0/42
port access vlan 20
int rang ten1/0/43 to ten1/0/48
port link-Aggregation group 300
int b300
port access vlan 30 
link-aggregation mode dynamic # 是不是dynamic也要对端确认 lacp 即动态汇聚

# 配置路由，移动量大走静态
ip route-static 0.0.0.0 0 10.130.33.1
# 策略路由
# 1.配置acl
acl  number 2010 
rule 10 permit source 58.216.101.191 0.0.0.63  # 反掩码要减1
acl number 2020
rule 10 permit source 103.45.78.0 0.0.0.127
# 2.配置策略路由规则
policy-based-route CTN permit node 10
 if-match acl 2010
 apply default-next-hop 10.103.36.1
#
policy-based-route CUN permit node 20
 if-match acl 2020
 apply default-next-hop 10.102.45.1
# 这里default-next-hop表示先去静态那边找路由表，没有再来这里策略路由这里找
# 应用策略路由
int vlan-interface 20
ip policy-based-route CUN
int vlan-interface 30
ip policy-based-route CTN

# 错误
# 错误
# 错误
# 错误
# 错误

# 配置传输
int vlan-interface 1
ip address 10.32.1.254 255.255.255.0
```

<font color='red'>上面策略路由的这样配置是错误的，最好把策略路由放在同一个组里面,另外策略都要配在vlan1那边，</font>

```bash
# 1. 配置acl
acl  number 2010 
rule 10 permit source 58.216.101.191 0.0.0.64
acl number 2020
rule 10 permit source 103.45.78.0 0.0.0.128
# 2. 配置策略路由 放在同一个组(MULTI-OUTBOUND)里面 node 0空出来留作备用
policy-based-route MULTI-OUTBOUND permit node 10
 if-match acl 2010
 apply default-next-hop 10.103.36.1
#
policy-based-route MULTI-OUTBOUND permit node 20
 if-match acl 2020
 apply default-next-hop 10.102.45.1

int vlan-interface 1
ip policy-based-route MULTI-OUTBOUND
```


> ipv6 配置策略路由

```bash
# 需求 两端ipv4+ipv6 默认路由走主的 策略路由走sub的
# 业务vlan
interface Vlan-interface1
 ip address 120.201.229.30 255.255.255.224
 ip address 120.201.229.65 255.255.255.224 sub
 ip policy-based-route MULTI-OUTBOUND
 ipv6 policy-based-route MULTI-OUTBOUND
 ipv6 address 2409:8C14:F1A:8902::1/64
 ipv6 address 2409:8C14:F1A:9B02::1/64
 undo ipv6 nd ra halt

# 配置v4和v6的acl路由，先拦截 然后按照策略路由走
acl number 2010
 rule 10 permit source 120.201.229.64 0.0.0.31
#
acl ipv6 number 2010
 rule 10 permit source 2409:8C14:F1A:9B02::/64

# 策略路由
policy-based-route MULTI-OUTBOUND permit node 10
 if-match acl 2010
 apply next-hop 192.168.113.1
#
ipv6 policy-based-route MULTI-OUTBOUND permit node 10
 if-match acl 2010
 apply next-hop FE30:1::
```